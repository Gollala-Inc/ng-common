import { Directive, EventEmitter, Input, Output } from '@angular/core';
import { BehaviorSubject, catchError, delay, filter, map, mergeMap, Observable, throwError, timer } from 'rxjs';
import { ajax } from 'rxjs/ajax';
import * as i0 from "@angular/core";
import * as i1 from "../service/intersection-observer.service";
const IMAGE_LOADING_PATH = 'assets/images/loading-message.png';
const IMAGE_NOT_FOUND_PATH = 'assets/images/not-found.png';
export class LazyImageDirective {
    constructor(el, ioService) {
        this.el = el;
        this.ioService = ioService;
        this.retryLimit = 1;
        this.beforeLoad = new EventEmitter();
        this.afterLoad = new EventEmitter();
        this.onError = new EventEmitter();
        this.load$ = new BehaviorSubject(null);
        this.retry$ = new BehaviorSubject(-1);
        this.status = 'INIT';
        this.subscriptions = [];
    }
    ngOnInit() {
        this.setup();
        this.initSubscriptions();
        this.attachIntersectionObserver();
        this.beforeLoaded();
    }
    ngOnChanges(changes) {
        if (!changes['lazySrc'].firstChange) {
            // 만약 재시도 중이었다면 취소시킴
            const currentRetryCount = this.retry$.value;
            if (currentRetryCount !== -1) {
                this.retry$.next(-1);
            }
            this.beforeLoaded();
            const src = changes['lazySrc'].currentValue;
            this.loadImage(src)
                .subscribe((data) => { this.load$.next({ src: data, event: null }); }, () => { this.retry$.next(this.retryLimit - 1); });
        }
    }
    ngOnDestroy() {
        this.unsubscribeAll();
    }
    setup() {
        this.ne = this.el.nativeElement;
    }
    initSubscriptions() {
        const loadSub = this.load$
            .pipe(filter(Boolean))
            .subscribe((loadEvent) => {
            const { event, src } = loadEvent;
            if (this.ne) {
                if (this.ne.tagName === 'IMG') {
                    const imgTag = this.ne;
                    imgTag.src = src;
                }
                else {
                    this.populateBackgroundStyles(this.ne, src);
                }
                this.afterLoad.emit({
                    el: this.el,
                    src,
                    intersectionObserver: this.observer,
                    event,
                });
            }
        });
        this.subscriptions.push(loadSub);
        const retrySub = this.retry$
            .pipe(filter(x => x !== -1), filter(x => this.status !== 'LOAD'), delay(3000))
            .subscribe(retryCount => {
            if (retryCount <= 0) {
                this.error();
                return;
            }
            if (this.lazySrc) {
                this.loadImage(this.lazySrc)
                    .subscribe(data => { this.load$.next({ src: data, event: null }); }, err => { this.retry$.next(retryCount - 1); });
            }
        });
        this.subscriptions.push(retrySub);
    }
    unsubscribeAll() {
        this.subscriptions.forEach(s => {
            s.unsubscribe();
        });
    }
    /**
     * try retrieve image from cache. if the image doesn't exist, try request.
     * @param url
     */
    loadImage(url) {
        return this.loadImageFromUrl(url);
    }
    loadImageFromUrl(url) {
        return ajax({
            url,
            crossDomain: true,
            responseType: 'arraybuffer',
        }).pipe(map((ajaxResponse) => {
            if (ajaxResponse.status >= 400) {
                throw new Error('Cannot image url');
            }
            return ajaxResponse.response;
        }), mergeMap((bufferArray) => {
            return Observable.create((observer) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    observer.next(reader.result);
                    observer.complete();
                };
                reader.onerror = (e) => {
                    observer.error(e);
                };
                reader.readAsDataURL(new Blob([bufferArray]));
            });
        }), catchError(e => throwError(e)));
    }
    attachIntersectionObserver() {
        /**
         * Lazy Loading
         */
        if (this.ne) {
            const { ixIn, ixOut } = this.ioService.observe(this.ne);
            let timerSub;
            const inSub = ixIn.subscribe((value) => {
                const { entry, observer } = value;
                if (timerSub && timerSub.closed) {
                    timerSub.unsubscribe();
                }
                this.status = 'LOADING';
                timerSub = timer(200)
                    .pipe(mergeMap(_ => this.loadImage(this.lazySrc || '')))
                    .subscribe(data => {
                    this.load$.next({ src: data, event: null });
                    observer.unobserve(entry.target);
                }, err => {
                    this.retry$.next(this.retryLimit);
                });
            });
            const outSub = ixOut.subscribe((value) => {
                if (timerSub) {
                    this.status = 'INIT';
                    timerSub.unsubscribe();
                }
            });
            this.subscriptions.push(inSub, outSub);
        }
    }
    beforeLoaded() {
        if (this.ne) {
            if (this.ne.tagName === 'IMG') {
                const imgTag = this.ne;
                imgTag.src = IMAGE_LOADING_PATH;
            }
            else {
                this.populateBackgroundStyles(this.ne, IMAGE_LOADING_PATH);
            }
            this.beforeLoad.emit({
                el: this.el,
                src: IMAGE_LOADING_PATH,
                intersectionObserver: this.observer
            });
        }
    }
    error() {
        if (this.ne) {
            if (this.ne.tagName === 'IMG') {
                const imgTag = this.el.nativeElement;
                imgTag.src = IMAGE_NOT_FOUND_PATH;
            }
            else {
                this.populateBackgroundStyles(this.ne, IMAGE_NOT_FOUND_PATH);
            }
            this.ioService.unobserve(this.ne);
            this.onError.emit({
                el: this.el,
                src: IMAGE_NOT_FOUND_PATH,
                intersectionObserver: this.observer,
                event,
            });
        }
    }
    populateBackgroundStyles(placeholder, imagePath) {
        placeholder.style.backgroundImage = `url(${imagePath})`;
        placeholder.style.backgroundPosition = 'center';
        placeholder.style.backgroundRepeat = 'no-repeat';
        placeholder.style.backgroundSize = 'contain';
    }
}
LazyImageDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: LazyImageDirective, deps: [{ token: i0.ElementRef }, { token: i1.IntersectionObserverService }], target: i0.ɵɵFactoryTarget.Directive });
LazyImageDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: LazyImageDirective, selector: "[lazyImage]", inputs: { lazySrc: ["lazyImage", "lazySrc"], ioOptions: "ioOptions", retryLimit: "retryLimit" }, outputs: { beforeLoad: "beforeLoad", afterLoad: "afterLoad", onError: "onError" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: LazyImageDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[lazyImage]'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.IntersectionObserverService }]; }, propDecorators: { lazySrc: [{
                type: Input,
                args: ['lazyImage']
            }], ioOptions: [{
                type: Input
            }], retryLimit: [{
                type: Input
            }], beforeLoad: [{
                type: Output
            }], afterLoad: [{
                type: Output
            }], onError: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS1pbWFnZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1jb21tb24vc3JjL2xpYi9kaXJlY3RpdmUvbGF6eS1pbWFnZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBYyxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDaEcsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixHQUFHLEVBQ0gsUUFBUSxFQUNSLFVBQVUsRUFFVixVQUFVLEVBQ1YsS0FBSyxFQUNOLE1BQU0sTUFBTSxDQUFDO0FBRWQsT0FBTyxFQUFDLElBQUksRUFBZSxNQUFNLFdBQVcsQ0FBQzs7O0FBRTdDLE1BQU0sa0JBQWtCLEdBQUcsbUNBQW1DLENBQUM7QUFDL0QsTUFBTSxvQkFBb0IsR0FBRyw2QkFBNkIsQ0FBQztBQWlCM0QsTUFBTSxPQUFPLGtCQUFrQjtJQW1CN0IsWUFDVSxFQUFjLEVBQ2QsU0FBc0M7UUFEdEMsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLGNBQVMsR0FBVCxTQUFTLENBQTZCO1FBbEJ2QyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsZUFBVSxHQUFpQyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQzlELGNBQVMsR0FBaUMsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM3RCxZQUFPLEdBQWlDLElBQUksWUFBWSxFQUFFLENBQUM7UUFFckUsVUFBSyxHQUFHLElBQUksZUFBZSxDQUFtQixJQUFJLENBQUMsQ0FBQztRQUNwRCxXQUFNLEdBQUcsSUFBSSxlQUFlLENBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV6QyxXQUFNLEdBQUcsTUFBTSxDQUFDO1FBRWhCLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztJQVduQyxDQUFDO0lBRUQsUUFBUTtRQUNOLElB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O1FBQ3hELFdBQVcsQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEdBQUcsUUFBUSxDQUFDO1FBQ2hELFdBQVcsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO1FBQ2pELFdBQVcsQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQztJQUMvQyxDQUFDOzsrR0F2T1Usa0JBQWtCO21HQUFsQixrQkFBa0I7MkZBQWxCLGtCQUFrQjtrQkFIOUIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsYUFBYTtpQkFDeEI7MklBRXFCLE9BQU87c0JBQTFCLEtBQUs7dUJBQUMsV0FBVztnQkFDVCxTQUFTO3NCQUFqQixLQUFLO2dCQUNHLFVBQVU7c0JBQWxCLEtBQUs7Z0JBQ0ksVUFBVTtzQkFBbkIsTUFBTTtnQkFDRyxTQUFTO3NCQUFsQixNQUFNO2dCQUNHLE9BQU87c0JBQWhCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICBCZWhhdmlvclN1YmplY3QsXHJcbiAgY2F0Y2hFcnJvcixcclxuICBkZWxheSxcclxuICBmaWx0ZXIsXHJcbiAgbWFwLFxyXG4gIG1lcmdlTWFwLFxyXG4gIE9ic2VydmFibGUsXHJcbiAgU3Vic2NyaXB0aW9uLFxyXG4gIHRocm93RXJyb3IsXHJcbiAgdGltZXJcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtFbnRyeUFuZE9ic2VydmVyLCBJbnRlcnNlY3Rpb25PYnNlcnZlclNlcnZpY2V9IGZyb20gJy4uL3NlcnZpY2UvaW50ZXJzZWN0aW9uLW9ic2VydmVyLnNlcnZpY2UnO1xyXG5pbXBvcnQge2FqYXgsIEFqYXhSZXNwb25zZX0gZnJvbSAncnhqcy9hamF4JztcclxuXHJcbmNvbnN0IElNQUdFX0xPQURJTkdfUEFUSCA9ICdhc3NldHMvaW1hZ2VzL2xvYWRpbmctbWVzc2FnZS5wbmcnO1xyXG5jb25zdCBJTUFHRV9OT1RfRk9VTkRfUEFUSCA9ICdhc3NldHMvaW1hZ2VzL25vdC1mb3VuZC5wbmcnO1xyXG5cclxuaW50ZXJmYWNlIExhenlJbWFnZUV2ZW50IHtcclxuICBlbDogRWxlbWVudFJlZjtcclxuICBzcmM6IHN0cmluZztcclxuICBpbnRlcnNlY3Rpb25PYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXIgfCB1bmRlZmluZWQ7XHJcbiAgZXZlbnQ/OiBFdmVudCB8IG51bGw7XHJcbn1cclxuXHJcbmludGVyZmFjZSBMb2FkRXZlbnQge1xyXG4gIHNyYzogc3RyaW5nO1xyXG4gIGV2ZW50OiBFdmVudCB8IG51bGw7XHJcbn1cclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2xhenlJbWFnZV0nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBMYXp5SW1hZ2VEaXJlY3RpdmUge1xyXG4gIEBJbnB1dCgnbGF6eUltYWdlJykgbGF6eVNyYzogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gIEBJbnB1dCgpIGlvT3B0aW9uczogYW55O1xyXG4gIEBJbnB1dCgpIHJldHJ5TGltaXQgPSAxO1xyXG4gIEBPdXRwdXQoKSBiZWZvcmVMb2FkOiBFdmVudEVtaXR0ZXI8TGF6eUltYWdlRXZlbnQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gIEBPdXRwdXQoKSBhZnRlckxvYWQ6IEV2ZW50RW1pdHRlcjxMYXp5SW1hZ2VFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgQE91dHB1dCgpIG9uRXJyb3I6IEV2ZW50RW1pdHRlcjxMYXp5SW1hZ2VFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gIGxvYWQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxMb2FkRXZlbnQgfCBudWxsPihudWxsKTtcclxuICByZXRyeSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG51bWJlcj4oLTEpO1xyXG5cclxuICBzdGF0dXMgPSAnSU5JVCc7XHJcblxyXG4gIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XHJcblxyXG4gIG5lOiBIVE1MRWxlbWVudCB8IHVuZGVmaW5lZDtcclxuXHJcbiAgb2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyIHwgdW5kZWZpbmVkO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICBwcml2YXRlIGlvU2VydmljZTogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJTZXJ2aWNlLFxyXG4gICkge1xyXG5cclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zZXR1cCgpO1xyXG4gICAgdGhpcy5pbml0U3Vic2NyaXB0aW9ucygpO1xyXG4gICAgdGhpcy5hdHRhY2hJbnRlcnNlY3Rpb25PYnNlcnZlcigpO1xyXG4gICAgdGhpcy5iZWZvcmVMb2FkZWQoKTtcclxuICB9XHJcblxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBpZiAoIWNoYW5nZXNbJ2xhenlTcmMnXS5maXJzdENoYW5nZSkge1xyXG4gICAgICAvLyDrp4zslb0g7J6s7Iuc64+EIOykkeydtOyXiOuLpOuptCDst6jshozsi5ztgrRcclxuICAgICAgY29uc3QgY3VycmVudFJldHJ5Q291bnQgPSB0aGlzLnJldHJ5JC52YWx1ZTtcclxuICAgICAgaWYgKGN1cnJlbnRSZXRyeUNvdW50ICE9PSAtMSkge1xyXG4gICAgICAgIHRoaXMucmV0cnkkLm5leHQoLTEpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuYmVmb3JlTG9hZGVkKCk7XHJcbiAgICAgIGNvbnN0IHNyYyA9IGNoYW5nZXNbJ2xhenlTcmMnXS5jdXJyZW50VmFsdWU7XHJcbiAgICAgIHRoaXMubG9hZEltYWdlKHNyYylcclxuICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAoZGF0YTogYW55KSA9PiB7IHRoaXMubG9hZCQubmV4dCh7IHNyYzogZGF0YSwgZXZlbnQ6IG51bGwgfSk7IH0sXHJcbiAgICAgICAgICAoKSA9PiB7IHRoaXMucmV0cnkkLm5leHQodGhpcy5yZXRyeUxpbWl0IC0gMSk7IH1cclxuICAgICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLnVuc3Vic2NyaWJlQWxsKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldHVwKCkge1xyXG4gICAgdGhpcy5uZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdFN1YnNjcmlwdGlvbnMoKSB7XHJcbiAgICBjb25zdCBsb2FkU3ViID0gdGhpcy5sb2FkJFxyXG4gICAgICAucGlwZShmaWx0ZXIoQm9vbGVhbikpXHJcbiAgICAgIC5zdWJzY3JpYmUoKGxvYWRFdmVudDogTG9hZEV2ZW50KSA9PiB7XHJcbiAgICAgICAgY29uc3Qge2V2ZW50LCBzcmN9ID0gbG9hZEV2ZW50O1xyXG4gICAgICAgIGlmICh0aGlzLm5lKSB7XHJcbiAgICAgICAgICBpZiAodGhpcy5uZS50YWdOYW1lID09PSAnSU1HJykge1xyXG4gICAgICAgICAgICBjb25zdCBpbWdUYWcgPSB0aGlzLm5lIGFzIEhUTUxJbWFnZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGltZ1RhZy5zcmMgPSBzcmM7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wb3B1bGF0ZUJhY2tncm91bmRTdHlsZXModGhpcy5uZSwgc3JjKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0aGlzLmFmdGVyTG9hZC5lbWl0KHtcclxuICAgICAgICAgICAgZWw6IHRoaXMuZWwsXHJcbiAgICAgICAgICAgIHNyYyxcclxuICAgICAgICAgICAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IHRoaXMub2JzZXJ2ZXIsXHJcbiAgICAgICAgICAgIGV2ZW50LFxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChsb2FkU3ViKTtcclxuXHJcbiAgICBjb25zdCByZXRyeVN1YiA9IHRoaXMucmV0cnkkXHJcbiAgICAgIC5waXBlKFxyXG4gICAgICAgIGZpbHRlcih4ID0+IHggIT09IC0xKSxcclxuICAgICAgICBmaWx0ZXIoeCA9PiB0aGlzLnN0YXR1cyAhPT0gJ0xPQUQnKSxcclxuICAgICAgICBkZWxheSgzMDAwKSxcclxuICAgICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKHJldHJ5Q291bnQgPT4ge1xyXG4gICAgICAgIGlmIChyZXRyeUNvdW50IDw9IDApIHtcclxuICAgICAgICAgIHRoaXMuZXJyb3IoKTtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMubGF6eVNyYykge1xyXG4gICAgICAgICAgdGhpcy5sb2FkSW1hZ2UodGhpcy5sYXp5U3JjKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgIGRhdGEgPT4geyB0aGlzLmxvYWQkLm5leHQoeyBzcmM6IGRhdGEsIGV2ZW50OiBudWxsIH0pOyB9LFxyXG4gICAgICAgICAgICAgIGVyciA9PiB7IHRoaXMucmV0cnkkLm5leHQocmV0cnlDb3VudCAtIDEpOyB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChyZXRyeVN1Yik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVuc3Vic2NyaWJlQWxsKCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmZvckVhY2gocyA9PiB7XHJcbiAgICAgIHMudW5zdWJzY3JpYmUoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogdHJ5IHJldHJpZXZlIGltYWdlIGZyb20gY2FjaGUuIGlmIHRoZSBpbWFnZSBkb2Vzbid0IGV4aXN0LCB0cnkgcmVxdWVzdC5cclxuICAgKiBAcGFyYW0gdXJsXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsb2FkSW1hZ2UodXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIHRoaXMubG9hZEltYWdlRnJvbVVybCh1cmwpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBsb2FkSW1hZ2VGcm9tVXJsKHVybDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiBhamF4KHtcclxuICAgICAgdXJsLFxyXG4gICAgICBjcm9zc0RvbWFpbjogdHJ1ZSxcclxuICAgICAgcmVzcG9uc2VUeXBlOiAnYXJyYXlidWZmZXInLFxyXG4gICAgfSkucGlwZShcclxuICAgICAgbWFwKChhamF4UmVzcG9uc2U6IEFqYXhSZXNwb25zZTxhbnk+KSA9PiB7XHJcbiAgICAgICAgaWYgKGFqYXhSZXNwb25zZS5zdGF0dXMgPj0gNDAwKSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBpbWFnZSB1cmwnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGFqYXhSZXNwb25zZS5yZXNwb25zZTtcclxuICAgICAgfSksXHJcbiAgICAgIG1lcmdlTWFwKChidWZmZXJBcnJheTogQXJyYXlCdWZmZXIpID0+IHtcclxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiB7IG5leHQ6IChhcmcwOiBzdHJpbmcgfCBBcnJheUJ1ZmZlciB8IG51bGwpID0+IHZvaWQ7IGNvbXBsZXRlOiAoKSA9PiB2b2lkOyBlcnJvcjogKGFyZzA6IFByb2dyZXNzRXZlbnQ8RmlsZVJlYWRlcj4pID0+IHZvaWQ7IH0pID0+IHtcclxuICAgICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcbiAgICAgICAgICByZWFkZXIub25sb2FkID0gKGUpID0+IHtcclxuICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZWFkZXIucmVzdWx0KTtcclxuICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICByZWFkZXIub25lcnJvciA9IChlKSA9PiB7XHJcbiAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGUpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKG5ldyBCbG9iKFtidWZmZXJBcnJheV0pKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSksXHJcbiAgICAgIGNhdGNoRXJyb3IoZSA9PiB0aHJvd0Vycm9yKGUpKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGF0dGFjaEludGVyc2VjdGlvbk9ic2VydmVyKCkge1xyXG4gICAgLyoqXHJcbiAgICAgKiBMYXp5IExvYWRpbmdcclxuICAgICAqL1xyXG4gICAgaWYgKHRoaXMubmUpIHtcclxuICAgICAgY29uc3Qge2l4SW4sIGl4T3V0fSA9IHRoaXMuaW9TZXJ2aWNlLm9ic2VydmUodGhpcy5uZSk7XHJcblxyXG4gICAgICBsZXQgdGltZXJTdWI6IFN1YnNjcmlwdGlvbjtcclxuICAgICAgY29uc3QgaW5TdWIgPSBpeEluLnN1YnNjcmliZSgodmFsdWU6IEVudHJ5QW5kT2JzZXJ2ZXIpID0+IHtcclxuICAgICAgICBjb25zdCB7ZW50cnksIG9ic2VydmVyfSA9IHZhbHVlO1xyXG4gICAgICAgIGlmICh0aW1lclN1YiAmJiB0aW1lclN1Yi5jbG9zZWQpIHtcclxuICAgICAgICAgIHRpbWVyU3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3RhdHVzID0gJ0xPQURJTkcnO1xyXG4gICAgICAgIHRpbWVyU3ViID0gdGltZXIoMjAwKVxyXG4gICAgICAgICAgLnBpcGUobWVyZ2VNYXAoXyA9PiB0aGlzLmxvYWRJbWFnZSh0aGlzLmxhenlTcmMgfHwgJycpKSlcclxuICAgICAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZCQubmV4dCh7IHNyYzogZGF0YSwgZXZlbnQ6IG51bGwgfSk7XHJcbiAgICAgICAgICAgIG9ic2VydmVyLnVub2JzZXJ2ZShlbnRyeS50YXJnZXQpO1xyXG4gICAgICAgICAgfSwgZXJyID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yZXRyeSQubmV4dCh0aGlzLnJldHJ5TGltaXQpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3Qgb3V0U3ViID0gaXhPdXQuc3Vic2NyaWJlKCh2YWx1ZTogRW50cnlBbmRPYnNlcnZlcikgPT4ge1xyXG4gICAgICAgIGlmICh0aW1lclN1Yikge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSAnSU5JVCc7XHJcbiAgICAgICAgICB0aW1lclN1Yi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChpblN1Yiwgb3V0U3ViKTtcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJlZm9yZUxvYWRlZCgpIHtcclxuICAgIGlmICh0aGlzLm5lKSB7XHJcbiAgICAgIGlmICh0aGlzLm5lLnRhZ05hbWUgPT09ICdJTUcnKSB7XHJcbiAgICAgICAgY29uc3QgaW1nVGFnID0gdGhpcy5uZSBhcyBIVE1MSW1hZ2VFbGVtZW50O1xyXG4gICAgICAgIGltZ1RhZy5zcmMgPSBJTUFHRV9MT0FESU5HX1BBVEg7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgdGhpcy5wb3B1bGF0ZUJhY2tncm91bmRTdHlsZXModGhpcy5uZSwgSU1BR0VfTE9BRElOR19QQVRIKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5iZWZvcmVMb2FkLmVtaXQoe1xyXG4gICAgICAgIGVsOiB0aGlzLmVsLFxyXG4gICAgICAgIHNyYzogSU1BR0VfTE9BRElOR19QQVRILFxyXG4gICAgICAgIGludGVyc2VjdGlvbk9ic2VydmVyOiB0aGlzLm9ic2VydmVyXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlcnJvcigpIHtcclxuICAgIGlmICh0aGlzLm5lKSB7XHJcbiAgICAgIGlmICh0aGlzLm5lLnRhZ05hbWUgPT09ICdJTUcnKSB7XHJcbiAgICAgICAgY29uc3QgaW1nVGFnID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50IGFzIEhUTUxJbWFnZUVsZW1lbnQ7XHJcbiAgICAgICAgaW1nVGFnLnNyYyA9IElNQUdFX05PVF9GT1VORF9QQVRIO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHRoaXMucG9wdWxhdGVCYWNrZ3JvdW5kU3R5bGVzKHRoaXMubmUsIElNQUdFX05PVF9GT1VORF9QQVRIKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5pb1NlcnZpY2UudW5vYnNlcnZlKHRoaXMubmUpO1xyXG5cclxuICAgICAgdGhpcy5vbkVycm9yLmVtaXQoe1xyXG4gICAgICAgIGVsOiB0aGlzLmVsLFxyXG4gICAgICAgIHNyYzogSU1BR0VfTk9UX0ZPVU5EX1BBVEgsXHJcbiAgICAgICAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IHRoaXMub2JzZXJ2ZXIsXHJcbiAgICAgICAgZXZlbnQsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIHByaXZhdGUgcG9wdWxhdGVCYWNrZ3JvdW5kU3R5bGVzKHBsYWNlaG9sZGVyOiBIVE1MRWxlbWVudCwgaW1hZ2VQYXRoOiBzdHJpbmcpIHtcclxuICAgIHBsYWNlaG9sZGVyLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGB1cmwoJHtpbWFnZVBhdGh9KWA7XHJcbiAgICBwbGFjZWhvbGRlci5zdHlsZS5iYWNrZ3JvdW5kUG9zaXRpb24gPSAnY2VudGVyJztcclxuICAgIHBsYWNlaG9sZGVyLnN0eWxlLmJhY2tncm91bmRSZXBlYXQgPSAnbm8tcmVwZWF0JztcclxuICAgIHBsYWNlaG9sZGVyLnN0eWxlLmJhY2tncm91bmRTaXplID0gJ2NvbnRhaW4nO1xyXG4gIH1cclxuXHJcbn1cclxuIl19