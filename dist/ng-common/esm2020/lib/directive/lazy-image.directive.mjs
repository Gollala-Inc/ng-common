import { Directive, EventEmitter, Input, Output } from '@angular/core';
import { BehaviorSubject, catchError, delay, filter, map, mergeMap, Observable, throwError, timer } from 'rxjs';
import { ajax } from 'rxjs/ajax';
import * as i0 from "@angular/core";
import * as i1 from "../service/intersection-observer.service";
const IMAGE_LOADING_PATH = 'assets/images/loading-message.png';
const IMAGE_NOT_FOUND_PATH = 'assets/images/not-found.png';
export class LazyImageDirective {
    constructor(el, ioService) {
        this.el = el;
        this.ioService = ioService;
        this.retryLimit = 1;
        this.beforeLoad = new EventEmitter();
        this.afterLoad = new EventEmitter();
        this.onError = new EventEmitter();
        this.load$ = new BehaviorSubject(null);
        this.retry$ = new BehaviorSubject(-1);
        this.status = 'INIT';
        this.subscriptions = [];
    }
    ngOnInit() {
        this.setup();
        this.initSubscriptions();
        this.attachIntersectionObserver();
        this.beforeLoaded();
    }
    ngOnChanges(changes) {
        if (!changes['lazySrc'].firstChange) {
            // 만약 재시도 중이었다면 취소시킴
            const currentRetryCount = this.retry$.value;
            if (currentRetryCount !== -1) {
                this.retry$.next(-1);
            }
            this.beforeLoaded();
            const src = changes['lazySrc'].currentValue;
            this.loadImage(src)
                .subscribe((data) => { this.load$.next({ src: data, event: null }); }, () => { this.retry$.next(this.retryLimit - 1); });
        }
    }
    ngOnDestroy() {
        this.unsubscribeAll();
    }
    setup() {
        this.ne = this.el.nativeElement;
    }
    initSubscriptions() {
        const loadSub = this.load$
            .pipe(filter(Boolean))
            .subscribe((loadEvent) => {
            const { event, src } = loadEvent;
            if (this.ne) {
                if (this.ne.tagName === 'IMG') {
                    const imgTag = this.ne;
                    imgTag.src = src;
                }
                else {
                    this.populateBackgroundStyles(this.ne, src);
                }
                this.afterLoad.emit({
                    el: this.el,
                    src,
                    intersectionObserver: this.observer,
                    event,
                });
            }
        });
        this.subscriptions.push(loadSub);
        const retrySub = this.retry$
            .pipe(filter(x => x !== -1), filter(x => this.status !== 'LOAD'), delay(3000))
            .subscribe(retryCount => {
            if (retryCount <= 0) {
                this.error();
                return;
            }
            if (this.lazySrc) {
                this.loadImage(this.lazySrc)
                    .subscribe(data => { this.load$.next({ src: data, event: null }); }, err => { this.retry$.next(retryCount - 1); });
            }
        });
        this.subscriptions.push(retrySub);
    }
    unsubscribeAll() {
        this.subscriptions.forEach(s => {
            s.unsubscribe();
        });
    }
    /**
     * try retrieve image from cache. if the image doesn't exist, try request.
     * @param url
     */
    loadImage(url) {
        return this.loadImageFromUrl(url);
    }
    loadImageFromUrl(url) {
        return ajax({
            url,
            crossDomain: true,
            responseType: 'arraybuffer',
        }).pipe(map((ajaxResponse) => {
            if (ajaxResponse.status >= 400) {
                throw new Error('Cannot image url');
            }
            return ajaxResponse.response;
        }), mergeMap((bufferArray) => {
            return Observable.create((observer) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    observer.next(reader.result);
                    observer.complete();
                };
                reader.onerror = (e) => {
                    observer.error(e);
                };
                reader.readAsDataURL(new Blob([bufferArray]));
            });
        }), catchError(e => throwError(e)));
    }
    attachIntersectionObserver() {
        /**
         * Lazy Loading
         */
        if (this.ne) {
            const { ixIn, ixOut } = this.ioService.observe(this.ne);
            let timerSub;
            const inSub = ixIn.subscribe((value) => {
                const { entry, observer } = value;
                if (timerSub && timerSub.closed) {
                    timerSub.unsubscribe();
                }
                this.status = 'LOADING';
                timerSub = timer(200)
                    .pipe(mergeMap(_ => this.loadImage(this.lazySrc || '')))
                    .subscribe(data => {
                    this.load$.next({ src: data, event: null });
                    observer.unobserve(entry.target);
                }, err => {
                    this.retry$.next(this.retryLimit);
                });
            });
            const outSub = ixOut.subscribe((value) => {
                if (timerSub) {
                    this.status = 'INIT';
                    timerSub.unsubscribe();
                }
            });
            this.subscriptions.push(inSub, outSub);
        }
    }
    beforeLoaded() {
        if (this.ne) {
            if (this.ne.tagName === 'IMG') {
                const imgTag = this.ne;
                imgTag.src = IMAGE_LOADING_PATH;
            }
            else {
                this.populateBackgroundStyles(this.ne, IMAGE_LOADING_PATH);
            }
            this.beforeLoad.emit({
                el: this.el,
                src: IMAGE_LOADING_PATH,
                intersectionObserver: this.observer
            });
        }
    }
    error() {
        if (this.ne) {
            if (this.ne.tagName === 'IMG') {
                const imgTag = this.el.nativeElement;
                imgTag.src = IMAGE_NOT_FOUND_PATH;
            }
            else {
                this.populateBackgroundStyles(this.ne, IMAGE_NOT_FOUND_PATH);
            }
            this.ioService.unobserve(this.ne);
            this.onError.emit({
                el: this.el,
                src: IMAGE_NOT_FOUND_PATH,
                intersectionObserver: this.observer,
                event,
            });
        }
    }
    populateBackgroundStyles(placeholder, imagePath) {
        placeholder.style.backgroundImage = `url(${imagePath})`;
        placeholder.style.backgroundPosition = 'center';
        placeholder.style.backgroundRepeat = 'no-repeat';
        placeholder.style.backgroundSize = 'contain';
    }
}
LazyImageDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: LazyImageDirective, deps: [{ token: i0.ElementRef }, { token: i1.IntersectionObserverService }], target: i0.ɵɵFactoryTarget.Directive });
LazyImageDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.1.3", type: LazyImageDirective, selector: "[lazyImage]", inputs: { lazySrc: ["lazyImage", "lazySrc"], ioOptions: "ioOptions", retryLimit: "retryLimit" }, outputs: { beforeLoad: "beforeLoad", afterLoad: "afterLoad", onError: "onError" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: LazyImageDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[lazyImage]'
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.IntersectionObserverService }]; }, propDecorators: { lazySrc: [{
                type: Input,
                args: ['lazyImage']
            }], ioOptions: [{
                type: Input
            }], retryLimit: [{
                type: Input
            }], beforeLoad: [{
                type: Output
            }], afterLoad: [{
                type: Output
            }], onError: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS1pbWFnZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1jb21tb24vc3JjL2xpYi9kaXJlY3RpdmUvbGF6eS1pbWFnZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBYyxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDaEcsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixHQUFHLEVBQ0gsUUFBUSxFQUNSLFVBQVUsRUFFVixVQUFVLEVBQ1YsS0FBSyxFQUNOLE1BQU0sTUFBTSxDQUFDO0FBRWQsT0FBTyxFQUFDLElBQUksRUFBZSxNQUFNLFdBQVcsQ0FBQzs7O0FBRTdDLE1BQU0sa0JBQWtCLEdBQUcsbUNBQW1DLENBQUM7QUFDL0QsTUFBTSxvQkFBb0IsR0FBRyw2QkFBNkIsQ0FBQztBQWlCM0QsTUFBTSxPQUFPLGtCQUFrQjtJQW1CN0IsWUFDVSxFQUFjLEVBQ2QsU0FBc0M7UUFEdEMsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLGNBQVMsR0FBVCxTQUFTLENBQTZCO1FBbEJ2QyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsZUFBVSxHQUFpQyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQzlELGNBQVMsR0FBaUMsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM3RCxZQUFPLEdBQWlDLElBQUksWUFBWSxFQUFFLENBQUM7UUFFckUsVUFBSyxHQUFHLElBQUksZUFBZSxDQUFtQixJQUFJLENBQUMsQ0FBQztRQUNwRCxXQUFNLEdBQUcsSUFBSSxlQUFlLENBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV6QyxXQUFNLEdBQUcsTUFBTSxDQUFDO1FBRWhCLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztJQVduQyxDQUFDO0lBRUQsUUFBUTtRQUNOLElB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O1FBQ3hELFdBQVcsQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEdBQUcsUUFBUSxDQUFDO1FBQ2hELFdBQVcsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEdBQUcsV0FBVyxDQUFDO1FBQ2pELFdBQVcsQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQztJQUMvQyxDQUFDOzsrR0F2T1Usa0JBQWtCO21HQUFsQixrQkFBa0I7MkZBQWxCLGtCQUFrQjtrQkFIOUIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsYUFBYTtpQkFDeEI7MklBRXFCLE9BQU87c0JBQTFCLEtBQUs7dUJBQUMsV0FBVztnQkFDVCxTQUFTO3NCQUFqQixLQUFLO2dCQUNHLFVBQVU7c0JBQWxCLEtBQUs7Z0JBQ0ksVUFBVTtzQkFBbkIsTUFBTTtnQkFDRyxTQUFTO3NCQUFsQixNQUFNO2dCQUNHLE9BQU87c0JBQWhCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBTaW1wbGVDaGFuZ2VzfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEJlaGF2aW9yU3ViamVjdCxcbiAgY2F0Y2hFcnJvcixcbiAgZGVsYXksXG4gIGZpbHRlcixcbiAgbWFwLFxuICBtZXJnZU1hcCxcbiAgT2JzZXJ2YWJsZSxcbiAgU3Vic2NyaXB0aW9uLFxuICB0aHJvd0Vycm9yLFxuICB0aW1lclxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7RW50cnlBbmRPYnNlcnZlciwgSW50ZXJzZWN0aW9uT2JzZXJ2ZXJTZXJ2aWNlfSBmcm9tICcuLi9zZXJ2aWNlL2ludGVyc2VjdGlvbi1vYnNlcnZlci5zZXJ2aWNlJztcbmltcG9ydCB7YWpheCwgQWpheFJlc3BvbnNlfSBmcm9tICdyeGpzL2FqYXgnO1xuXG5jb25zdCBJTUFHRV9MT0FESU5HX1BBVEggPSAnYXNzZXRzL2ltYWdlcy9sb2FkaW5nLW1lc3NhZ2UucG5nJztcbmNvbnN0IElNQUdFX05PVF9GT1VORF9QQVRIID0gJ2Fzc2V0cy9pbWFnZXMvbm90LWZvdW5kLnBuZyc7XG5cbmludGVyZmFjZSBMYXp5SW1hZ2VFdmVudCB7XG4gIGVsOiBFbGVtZW50UmVmO1xuICBzcmM6IHN0cmluZztcbiAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyIHwgdW5kZWZpbmVkO1xuICBldmVudD86IEV2ZW50IHwgbnVsbDtcbn1cblxuaW50ZXJmYWNlIExvYWRFdmVudCB7XG4gIHNyYzogc3RyaW5nO1xuICBldmVudDogRXZlbnQgfCBudWxsO1xufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbGF6eUltYWdlXSdcbn0pXG5leHBvcnQgY2xhc3MgTGF6eUltYWdlRGlyZWN0aXZlIHtcbiAgQElucHV0KCdsYXp5SW1hZ2UnKSBsYXp5U3JjOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIEBJbnB1dCgpIGlvT3B0aW9uczogYW55O1xuICBASW5wdXQoKSByZXRyeUxpbWl0ID0gMTtcbiAgQE91dHB1dCgpIGJlZm9yZUxvYWQ6IEV2ZW50RW1pdHRlcjxMYXp5SW1hZ2VFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBhZnRlckxvYWQ6IEV2ZW50RW1pdHRlcjxMYXp5SW1hZ2VFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBvbkVycm9yOiBFdmVudEVtaXR0ZXI8TGF6eUltYWdlRXZlbnQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIGxvYWQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxMb2FkRXZlbnQgfCBudWxsPihudWxsKTtcbiAgcmV0cnkkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxudW1iZXI+KC0xKTtcblxuICBzdGF0dXMgPSAnSU5JVCc7XG5cbiAgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcblxuICBuZTogSFRNTEVsZW1lbnQgfCB1bmRlZmluZWQ7XG5cbiAgb2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyIHwgdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBpb1NlcnZpY2U6IEludGVyc2VjdGlvbk9ic2VydmVyU2VydmljZSxcbiAgKSB7XG5cbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuc2V0dXAoKTtcbiAgICB0aGlzLmluaXRTdWJzY3JpcHRpb25zKCk7XG4gICAgdGhpcy5hdHRhY2hJbnRlcnNlY3Rpb25PYnNlcnZlcigpO1xuICAgIHRoaXMuYmVmb3JlTG9hZGVkKCk7XG4gIH1cblxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoIWNoYW5nZXNbJ2xhenlTcmMnXS5maXJzdENoYW5nZSkge1xuICAgICAgLy8g66eM7JW9IOyerOyLnOuPhCDspJHsnbTsl4jri6TrqbQg7Leo7IaM7Iuc7YK0XG4gICAgICBjb25zdCBjdXJyZW50UmV0cnlDb3VudCA9IHRoaXMucmV0cnkkLnZhbHVlO1xuICAgICAgaWYgKGN1cnJlbnRSZXRyeUNvdW50ICE9PSAtMSkge1xuICAgICAgICB0aGlzLnJldHJ5JC5uZXh0KC0xKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYmVmb3JlTG9hZGVkKCk7XG4gICAgICBjb25zdCBzcmMgPSBjaGFuZ2VzWydsYXp5U3JjJ10uY3VycmVudFZhbHVlO1xuICAgICAgdGhpcy5sb2FkSW1hZ2Uoc3JjKVxuICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICAgKGRhdGE6IGFueSkgPT4geyB0aGlzLmxvYWQkLm5leHQoeyBzcmM6IGRhdGEsIGV2ZW50OiBudWxsIH0pOyB9LFxuICAgICAgICAgICgpID0+IHsgdGhpcy5yZXRyeSQubmV4dCh0aGlzLnJldHJ5TGltaXQgLSAxKTsgfVxuICAgICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMudW5zdWJzY3JpYmVBbGwoKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXAoKSB7XG4gICAgdGhpcy5uZSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFN1YnNjcmlwdGlvbnMoKSB7XG4gICAgY29uc3QgbG9hZFN1YiA9IHRoaXMubG9hZCRcbiAgICAgIC5waXBlKGZpbHRlcihCb29sZWFuKSlcbiAgICAgIC5zdWJzY3JpYmUoKGxvYWRFdmVudDogTG9hZEV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHtldmVudCwgc3JjfSA9IGxvYWRFdmVudDtcbiAgICAgICAgaWYgKHRoaXMubmUpIHtcbiAgICAgICAgICBpZiAodGhpcy5uZS50YWdOYW1lID09PSAnSU1HJykge1xuICAgICAgICAgICAgY29uc3QgaW1nVGFnID0gdGhpcy5uZSBhcyBIVE1MSW1hZ2VFbGVtZW50O1xuICAgICAgICAgICAgaW1nVGFnLnNyYyA9IHNyYztcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVsYXRlQmFja2dyb3VuZFN0eWxlcyh0aGlzLm5lLCBzcmMpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuYWZ0ZXJMb2FkLmVtaXQoe1xuICAgICAgICAgICAgZWw6IHRoaXMuZWwsXG4gICAgICAgICAgICBzcmMsXG4gICAgICAgICAgICBpbnRlcnNlY3Rpb25PYnNlcnZlcjogdGhpcy5vYnNlcnZlcixcbiAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKGxvYWRTdWIpO1xuXG4gICAgY29uc3QgcmV0cnlTdWIgPSB0aGlzLnJldHJ5JFxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcih4ID0+IHggIT09IC0xKSxcbiAgICAgICAgZmlsdGVyKHggPT4gdGhpcy5zdGF0dXMgIT09ICdMT0FEJyksXG4gICAgICAgIGRlbGF5KDMwMDApLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShyZXRyeUNvdW50ID0+IHtcbiAgICAgICAgaWYgKHJldHJ5Q291bnQgPD0gMCkge1xuICAgICAgICAgIHRoaXMuZXJyb3IoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubGF6eVNyYykge1xuICAgICAgICAgIHRoaXMubG9hZEltYWdlKHRoaXMubGF6eVNyYylcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgIGRhdGEgPT4geyB0aGlzLmxvYWQkLm5leHQoeyBzcmM6IGRhdGEsIGV2ZW50OiBudWxsIH0pOyB9LFxuICAgICAgICAgICAgICBlcnIgPT4geyB0aGlzLnJldHJ5JC5uZXh0KHJldHJ5Q291bnQgLSAxKTsgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChyZXRyeVN1Yik7XG4gIH1cblxuICBwcml2YXRlIHVuc3Vic2NyaWJlQWxsKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5mb3JFYWNoKHMgPT4ge1xuICAgICAgcy51bnN1YnNjcmliZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIHRyeSByZXRyaWV2ZSBpbWFnZSBmcm9tIGNhY2hlLiBpZiB0aGUgaW1hZ2UgZG9lc24ndCBleGlzdCwgdHJ5IHJlcXVlc3QuXG4gICAqIEBwYXJhbSB1cmxcbiAgICovXG4gIHByaXZhdGUgbG9hZEltYWdlKHVybDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5sb2FkSW1hZ2VGcm9tVXJsKHVybCk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRJbWFnZUZyb21VcmwodXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBhamF4KHtcbiAgICAgIHVybCxcbiAgICAgIGNyb3NzRG9tYWluOiB0cnVlLFxuICAgICAgcmVzcG9uc2VUeXBlOiAnYXJyYXlidWZmZXInLFxuICAgIH0pLnBpcGUoXG4gICAgICBtYXAoKGFqYXhSZXNwb25zZTogQWpheFJlc3BvbnNlPGFueT4pID0+IHtcbiAgICAgICAgaWYgKGFqYXhSZXNwb25zZS5zdGF0dXMgPj0gNDAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaW1hZ2UgdXJsJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFqYXhSZXNwb25zZS5yZXNwb25zZTtcbiAgICAgIH0pLFxuICAgICAgbWVyZ2VNYXAoKGJ1ZmZlckFycmF5OiBBcnJheUJ1ZmZlcikgPT4ge1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiB7IG5leHQ6IChhcmcwOiBzdHJpbmcgfCBBcnJheUJ1ZmZlciB8IG51bGwpID0+IHZvaWQ7IGNvbXBsZXRlOiAoKSA9PiB2b2lkOyBlcnJvcjogKGFyZzA6IFByb2dyZXNzRXZlbnQ8RmlsZVJlYWRlcj4pID0+IHZvaWQ7IH0pID0+IHtcbiAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgICAgICAgIHJlYWRlci5vbmxvYWQgPSAoZSkgPT4ge1xuICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZWFkZXIucmVzdWx0KTtcbiAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICByZWFkZXIub25lcnJvciA9IChlKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlKTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKG5ldyBCbG9iKFtidWZmZXJBcnJheV0pKTtcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZSA9PiB0aHJvd0Vycm9yKGUpKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhdHRhY2hJbnRlcnNlY3Rpb25PYnNlcnZlcigpIHtcbiAgICAvKipcbiAgICAgKiBMYXp5IExvYWRpbmdcbiAgICAgKi9cbiAgICBpZiAodGhpcy5uZSkge1xuICAgICAgY29uc3Qge2l4SW4sIGl4T3V0fSA9IHRoaXMuaW9TZXJ2aWNlLm9ic2VydmUodGhpcy5uZSk7XG5cbiAgICAgIGxldCB0aW1lclN1YjogU3Vic2NyaXB0aW9uO1xuICAgICAgY29uc3QgaW5TdWIgPSBpeEluLnN1YnNjcmliZSgodmFsdWU6IEVudHJ5QW5kT2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgY29uc3Qge2VudHJ5LCBvYnNlcnZlcn0gPSB2YWx1ZTtcbiAgICAgICAgaWYgKHRpbWVyU3ViICYmIHRpbWVyU3ViLmNsb3NlZCkge1xuICAgICAgICAgIHRpbWVyU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zdGF0dXMgPSAnTE9BRElORyc7XG4gICAgICAgIHRpbWVyU3ViID0gdGltZXIoMjAwKVxuICAgICAgICAgIC5waXBlKG1lcmdlTWFwKF8gPT4gdGhpcy5sb2FkSW1hZ2UodGhpcy5sYXp5U3JjIHx8ICcnKSkpXG4gICAgICAgICAgLnN1YnNjcmliZShkYXRhID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9hZCQubmV4dCh7IHNyYzogZGF0YSwgZXZlbnQ6IG51bGwgfSk7XG4gICAgICAgICAgICBvYnNlcnZlci51bm9ic2VydmUoZW50cnkudGFyZ2V0KTtcbiAgICAgICAgICB9LCBlcnIgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXRyeSQubmV4dCh0aGlzLnJldHJ5TGltaXQpO1xuICAgICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IG91dFN1YiA9IGl4T3V0LnN1YnNjcmliZSgodmFsdWU6IEVudHJ5QW5kT2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgaWYgKHRpbWVyU3ViKSB7XG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSAnSU5JVCc7XG4gICAgICAgICAgdGltZXJTdWIudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKGluU3ViLCBvdXRTdWIpO1xuICAgIH1cblxuICB9XG5cbiAgcHJpdmF0ZSBiZWZvcmVMb2FkZWQoKSB7XG4gICAgaWYgKHRoaXMubmUpIHtcbiAgICAgIGlmICh0aGlzLm5lLnRhZ05hbWUgPT09ICdJTUcnKSB7XG4gICAgICAgIGNvbnN0IGltZ1RhZyA9IHRoaXMubmUgYXMgSFRNTEltYWdlRWxlbWVudDtcbiAgICAgICAgaW1nVGFnLnNyYyA9IElNQUdFX0xPQURJTkdfUEFUSDtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLnBvcHVsYXRlQmFja2dyb3VuZFN0eWxlcyh0aGlzLm5lLCBJTUFHRV9MT0FESU5HX1BBVEgpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmJlZm9yZUxvYWQuZW1pdCh7XG4gICAgICAgIGVsOiB0aGlzLmVsLFxuICAgICAgICBzcmM6IElNQUdFX0xPQURJTkdfUEFUSCxcbiAgICAgICAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IHRoaXMub2JzZXJ2ZXJcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZXJyb3IoKSB7XG4gICAgaWYgKHRoaXMubmUpIHtcbiAgICAgIGlmICh0aGlzLm5lLnRhZ05hbWUgPT09ICdJTUcnKSB7XG4gICAgICAgIGNvbnN0IGltZ1RhZyA9IHRoaXMuZWwubmF0aXZlRWxlbWVudCBhcyBIVE1MSW1hZ2VFbGVtZW50O1xuICAgICAgICBpbWdUYWcuc3JjID0gSU1BR0VfTk9UX0ZPVU5EX1BBVEg7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGhpcy5wb3B1bGF0ZUJhY2tncm91bmRTdHlsZXModGhpcy5uZSwgSU1BR0VfTk9UX0ZPVU5EX1BBVEgpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmlvU2VydmljZS51bm9ic2VydmUodGhpcy5uZSk7XG5cbiAgICAgIHRoaXMub25FcnJvci5lbWl0KHtcbiAgICAgICAgZWw6IHRoaXMuZWwsXG4gICAgICAgIHNyYzogSU1BR0VfTk9UX0ZPVU5EX1BBVEgsXG4gICAgICAgIGludGVyc2VjdGlvbk9ic2VydmVyOiB0aGlzLm9ic2VydmVyLFxuICAgICAgICBldmVudCxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG5cbiAgcHJpdmF0ZSBwb3B1bGF0ZUJhY2tncm91bmRTdHlsZXMocGxhY2Vob2xkZXI6IEhUTUxFbGVtZW50LCBpbWFnZVBhdGg6IHN0cmluZykge1xuICAgIHBsYWNlaG9sZGVyLnN0eWxlLmJhY2tncm91bmRJbWFnZSA9IGB1cmwoJHtpbWFnZVBhdGh9KWA7XG4gICAgcGxhY2Vob2xkZXIuc3R5bGUuYmFja2dyb3VuZFBvc2l0aW9uID0gJ2NlbnRlcic7XG4gICAgcGxhY2Vob2xkZXIuc3R5bGUuYmFja2dyb3VuZFJlcGVhdCA9ICduby1yZXBlYXQnO1xuICAgIHBsYWNlaG9sZGVyLnN0eWxlLmJhY2tncm91bmRTaXplID0gJ2NvbnRhaW4nO1xuICB9XG5cbn1cbiJdfQ==