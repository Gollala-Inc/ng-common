import { Injectable } from '@angular/core';
import { BehaviorSubject, of, throwError } from 'rxjs';
import { catchError, map, mergeMap } from 'rxjs/operators';
import * as CryptoJS from 'crypto-js';
import * as i0 from "@angular/core";
import * as i1 from "@gollala/ng-common";
const SIGNIN_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/login';
const SIGNEDIN_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/info';
const SEND_EMAIL = 'https://gollala-email-zaj3pqrsqq-du.a.run.app/api/email/send/verification/';
const SIGNOUT_ENDPOINT = '/api/security/v3/signout';
const SIGNUP_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/register';
const CHANGE_USER_ENDPOINT = '/api/security/v3/changeUser';
const GET_SERVICE_USER_ENDPOINT = '/api/account/serviceUser/get/';
const cypher = {
    initVector: 'wiseSecretVector',
    secretKey: 'wise$billing$key'
};
export class SecurityService {
    constructor(restService) {
        this.restService = restService;
        this._signedIn = false;
        this.signedIn$ = new BehaviorSubject(this._signedIn);
    }
    get signedIn() {
        return this._signedIn;
    }
    signUpReqeust(body) {
        return this.restService.POST(SIGNUP_ENDPOINT, {
            body,
            handleError: true,
            responseType: 'text'
        });
    }
    sendEmail(body) {
        return this.restService.POST(SEND_EMAIL, {
            body,
            handleError: true
        });
    }
    getUserInfo() {
        return this.restService.GET(SIGNEDIN_ENDPOINT, {
            handleError: true
        });
    }
    isExpiredToken(token) {
        const { date } = JSON.parse(token);
        const current = +new Date();
        const diff = current - date;
        return diff > 604800000 ? true : false;
    }
    signInRequest(userId, password) {
        return this.restService.POST(SIGNIN_ENDPOINT, {
            body: {
                userId,
                password
            },
            handleError: true,
            responseType: 'text'
        }).pipe(catchError((e) => {
            console.log(e);
            return throwError(e);
        }), mergeMap(token => {
            const gollalaToken = {
                token,
                date: +new Date()
            };
            localStorage.setItem('gollala_token', JSON.stringify(gollalaToken));
            return this.signedInRequest();
        }));
    }
    signedInRequest() {
        return this.restService.GET(SIGNEDIN_ENDPOINT, {
            handleError: true
        }).pipe(catchError(e => {
            this._signedIn = false;
            this.signedIn$.next(false);
            return throwError(e);
        }), map((signedIn) => {
            const gollalaToken = localStorage.getItem('gollala_token');
            if (!gollalaToken || (gollalaToken && this.isExpiredToken(gollalaToken))) {
                this._signedIn = false;
                return false;
            }
            this._signedIn = signedIn;
            return true;
        }));
    }
    signInWithGoogleRequest(idToken, provider) {
        return this.restService.POST(`https://commerce-api.gollala.org/customer/auth/social`, {
            params: {
                idToken,
                provider,
            },
            handleError: true,
            responseType: 'text'
        }).pipe(catchError((e) => {
            console.log(e);
            return throwError(e);
        }), mergeMap(token => {
            const gollalaToken = {
                token,
                date: +new Date()
            };
            localStorage.setItem('gollala_token', JSON.stringify(gollalaToken));
            return this.signedInRequest();
        }));
    }
    signout() {
        localStorage.removeItem('gollala_token');
        this._signedIn = false;
        this.signedIn$.next(null);
    }
    /**
     * This method will be deprecated after menus and paths are properly set.
     */
    signOutRequest() {
        return this.restService.GET(SIGNOUT_ENDPOINT, {
            responseType: 'text',
            handleError: true,
        }).pipe(catchError(e => {
            return throwError(e);
        }), mergeMap(result => {
            this._signedIn = false;
            return of(true);
        }));
    }
    changeUser(body) {
        return this.restService.POST(CHANGE_USER_ENDPOINT, {
            body,
            handleError: true,
        });
    }
    fileUploadToPath(file) {
        return this.restService.POST('/api/cdn/public/uploadFile', {
            multipart: true,
            params: {
                file: file,
            },
            responseType: 'text'
        });
    }
    getServiceUser() {
        const serviceUserId = this.signedIn.activeUserId;
        return this.restService.GET(`${GET_SERVICE_USER_ENDPOINT}/${serviceUserId}?b=true`);
    }
    encrypt(text) {
        // 이미 암호화 코드 상태이면 반환
        if (Number.isNaN(+text)) {
            return text;
        }
        const iv = CryptoJS.enc.Utf8.parse(cypher.initVector);
        const key = CryptoJS.enc.Utf8.parse(cypher.secretKey);
        const encrypted = CryptoJS.AES.encrypt(text, key, { iv: iv, padding: CryptoJS.pad.Pkcs7 }).toString();
        return encodeURIComponent(encrypted);
    }
    decrypt(text) {
        let decodeText = text;
        let decodeURI = decodeURIComponent(decodeText);
        while (decodeURI != decodeText) {
            decodeText = decodeURI;
            decodeURI = decodeURIComponent(decodeText);
        }
        const iv = CryptoJS.enc.Utf8.parse(cypher.initVector);
        const key = CryptoJS.enc.Utf8.parse(cypher.secretKey);
        const decrypted = CryptoJS.AES.decrypt(decodeURI, key, { iv: iv, padding: CryptoJS.pad.Pkcs7 });
        return decrypted.toString(CryptoJS.enc.Utf8);
    }
}
SecurityService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, deps: [{ token: i1.RestService }], target: i0.ɵɵFactoryTarget.Injectable });
SecurityService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.RestService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHktc2VydmljZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctY29tbW9uL3NyYy9saWIvc2VydmljZS9zZWN1cml0eS1zZXJ2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsZUFBZSxFQUFtQixFQUFFLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBRXBFLE9BQU8sS0FBSyxRQUFRLE1BQU0sV0FBVyxDQUFDOzs7QUFHdEMsTUFBTSxlQUFlLEdBQUcsc0RBQXNELENBQUM7QUFDL0UsTUFBTSxpQkFBaUIsR0FBRyxxREFBcUQsQ0FBQztBQUNoRixNQUFNLFVBQVUsR0FBRyw0RUFBNEUsQ0FBQztBQUNoRyxNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBQ3BELE1BQU0sZUFBZSxHQUFHLHlEQUF5RCxDQUFDO0FBQ2xGLE1BQU0sb0JBQW9CLEdBQUcsNkJBQTZCLENBQUM7QUFDM0QsTUFBTSx5QkFBeUIsR0FBRywrQkFBK0IsQ0FBQztBQU9sRSxNQUFNLE1BQU0sR0FBVztJQUNyQixVQUFVLEVBQUUsa0JBQWtCO0lBQzlCLFNBQVMsRUFBRSxrQkFBa0I7Q0FDOUIsQ0FBQztBQUtGLE1BQU0sT0FBTyxlQUFlO0lBTTFCLFlBQ1UsV0FBd0I7UUFBeEIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFMM0IsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUV6QixjQUFTLEdBQUcsSUFBSSxlQUFlLENBQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBSWxELENBQUM7SUFFSixJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENB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QkFIM0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgaWlmLCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Y2F0Y2hFcnJvciwgbWFwLCBtZXJnZU1hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7UmVzdFNlcnZpY2V9IGZyb20gJ0Bnb2xsYWxhL25nLWNvbW1vbic7XHJcbmltcG9ydCAqIGFzIENyeXB0b0pTIGZyb20gJ2NyeXB0by1qcyc7XHJcbmltcG9ydCB7SHR0cEhlYWRlcnN9IGZyb20gXCJAYW5ndWxhci9jb21tb24vaHR0cFwiO1xyXG5cclxuY29uc3QgU0lHTklOX0VORFBPSU5UID0gJ2h0dHBzOi8vY29tbWVyY2UtYXBpLmdvbGxhbGEub3JnL2N1c3RvbWVyL2F1dGgvbG9naW4nO1xyXG5jb25zdCBTSUdORURJTl9FTkRQT0lOVCA9ICdodHRwczovL2NvbW1lcmNlLWFwaS5nb2xsYWxhLm9yZy9jdXN0b21lci9hdXRoL2luZm8nO1xyXG5jb25zdCBTRU5EX0VNQUlMID0gJ2h0dHBzOi8vZ29sbGFsYS1lbWFpbC16YWozcHFyc3FxLWR1LmEucnVuLmFwcC9hcGkvZW1haWwvc2VuZC92ZXJpZmljYXRpb24vJztcclxuY29uc3QgU0lHTk9VVF9FTkRQT0lOVCA9ICcvYXBpL3NlY3VyaXR5L3YzL3NpZ25vdXQnO1xyXG5jb25zdCBTSUdOVVBfRU5EUE9JTlQgPSAnaHR0cHM6Ly9jb21tZXJjZS1hcGkuZ29sbGFsYS5vcmcvY3VzdG9tZXIvYXV0aC9yZWdpc3Rlcic7XHJcbmNvbnN0IENIQU5HRV9VU0VSX0VORFBPSU5UID0gJy9hcGkvc2VjdXJpdHkvdjMvY2hhbmdlVXNlcic7XHJcbmNvbnN0IEdFVF9TRVJWSUNFX1VTRVJfRU5EUE9JTlQgPSAnL2FwaS9hY2NvdW50L3NlcnZpY2VVc2VyL2dldC8nO1xyXG5cclxuaW50ZXJmYWNlIEN5cGhlciB7XHJcbiAgICBpbml0VmVjdG9yOiBzdHJpbmc7XHJcbiAgICBzZWNyZXRLZXk6IHN0cmluZztcclxufVxyXG5cclxuY29uc3QgY3lwaGVyOiBDeXBoZXIgPSB7XHJcbiAgaW5pdFZlY3RvcjogJ3dpc2VTZWNyZXRWZWN0b3InLFxyXG4gIHNlY3JldEtleTogJ3dpc2UkYmlsbGluZyRrZXknXHJcbn07XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTZWN1cml0eVNlcnZpY2Uge1xyXG5cclxuICBwdWJsaWMgX3NpZ25lZEluID0gZmFsc2U7XHJcblxyXG4gIHNpZ25lZEluJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55Pih0aGlzLl9zaWduZWRJbik7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXN0U2VydmljZTogUmVzdFNlcnZpY2UsXHJcbiAgKSB7fVxyXG5cclxuICBnZXQgc2lnbmVkSW4oKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl9zaWduZWRJbjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduVXBSZXFldXN0KGJvZHk6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuUE9TVChTSUdOVVBfRU5EUE9JTlQsIHtcclxuICAgICAgYm9keSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWUsXHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZW5kRW1haWwoYm9keTogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKFNFTkRfRU1BSUwsIHtcclxuICAgICAgYm9keSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWVcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcblxyXG4gIHB1YmxpYyBnZXRVc2VySW5mbygpIHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLkdFVChTSUdORURJTl9FTkRQT0lOVCwge1xyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaXNFeHBpcmVkVG9rZW4odG9rZW46IHN0cmluZykge1xyXG4gICAgY29uc3Qge2RhdGV9ID0gSlNPTi5wYXJzZSh0b2tlbilcclxuICAgIGNvbnN0IGN1cnJlbnQgPSArbmV3IERhdGUoKTtcclxuICAgIGNvbnN0IGRpZmYgPSBjdXJyZW50IC0gZGF0ZTtcclxuXHJcbiAgICByZXR1cm4gZGlmZiA+IDYwNDgwMDAwMCA/IHRydWUgOiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduSW5SZXF1ZXN0KHVzZXJJZDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKFNJR05JTl9FTkRQT0lOVCwge1xyXG4gICAgICBib2R5OiB7XHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIHBhc3N3b3JkXHJcbiAgICAgIH0sXHJcbiAgICAgIGhhbmRsZUVycm9yOiB0cnVlLFxyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0J1xyXG4gICAgfSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcigoZSkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGUpO1xyXG4gICAgICB9KSxcclxuICAgICAgbWVyZ2VNYXAodG9rZW4gPT4ge1xyXG4gICAgICAgIGNvbnN0IGdvbGxhbGFUb2tlbiA9IHtcclxuICAgICAgICAgIHRva2VuLFxyXG4gICAgICAgICAgZGF0ZTogK25ldyBEYXRlKClcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ29sbGFsYV90b2tlbicsIEpTT04uc3RyaW5naWZ5KGdvbGxhbGFUb2tlbikpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNpZ25lZEluUmVxdWVzdCgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduZWRJblJlcXVlc3QoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5HRVQoU0lHTkVESU5fRU5EUE9JTlQsIHtcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWVcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZSA9PiB7XHJcbiAgICAgICAgdGhpcy5fc2lnbmVkSW4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnNpZ25lZEluJC5uZXh0KGZhbHNlKTtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlKTtcclxuICAgICAgfSksXHJcbiAgICAgIG1hcCgoc2lnbmVkSW4pOiBhbnkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGdvbGxhbGFUb2tlbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdnb2xsYWxhX3Rva2VuJyk7XHJcbiAgICAgICAgaWYgKCFnb2xsYWxhVG9rZW4gfHwgKGdvbGxhbGFUb2tlbiAmJiB0aGlzLmlzRXhwaXJlZFRva2VuKGdvbGxhbGFUb2tlbikpKSB7XHJcbiAgICAgICAgICB0aGlzLl9zaWduZWRJbiA9IGZhbHNlO1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9zaWduZWRJbiA9IHNpZ25lZEluO1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduSW5XaXRoR29vZ2xlUmVxdWVzdChpZFRva2VuOiBzdHJpbmcsIHByb3ZpZGVyOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLlBPU1QoYGh0dHBzOi8vY29tbWVyY2UtYXBpLmdvbGxhbGEub3JnL2N1c3RvbWVyL2F1dGgvc29jaWFsYCwge1xyXG4gICAgICBwYXJhbXM6IHtcclxuICAgICAgICBpZFRva2VuLFxyXG4gICAgICAgIHByb3ZpZGVyLFxyXG4gICAgICB9LFxyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZSxcclxuICAgICAgcmVzcG9uc2VUeXBlOiAndGV4dCdcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoKGUpID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlKTtcclxuICAgICAgfSksXHJcbiAgICAgIG1lcmdlTWFwKHRva2VuID0+IHtcclxuICAgICAgICBjb25zdCBnb2xsYWxhVG9rZW4gPSB7XHJcbiAgICAgICAgICB0b2tlbixcclxuICAgICAgICAgIGRhdGU6ICtuZXcgRGF0ZSgpXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2dvbGxhbGFfdG9rZW4nLCBKU09OLnN0cmluZ2lmeShnb2xsYWxhVG9rZW4pKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5zaWduZWRJblJlcXVlc3QoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2lnbm91dCgpIHtcclxuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCdnb2xsYWxhX3Rva2VuJyk7XHJcbiAgICB0aGlzLl9zaWduZWRJbiA9IGZhbHNlO1xyXG4gICAgdGhpcy5zaWduZWRJbiQubmV4dChudWxsKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBUaGlzIG1ldGhvZCB3aWxsIGJlIGRlcHJlY2F0ZWQgYWZ0ZXIgbWVudXMgYW5kIHBhdGhzIGFyZSBwcm9wZXJseSBzZXQuXHJcbiAgICovXHJcblxyXG4gIHB1YmxpYyBzaWduT3V0UmVxdWVzdCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLkdFVChTSUdOT1VUX0VORFBPSU5ULCB7XHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnLFxyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZSxcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZSk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBtZXJnZU1hcChyZXN1bHQgPT4ge1xyXG4gICAgICAgIHRoaXMuX3NpZ25lZEluID0gZmFsc2U7XHJcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBjaGFuZ2VVc2VyKGJvZHk6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuUE9TVChDSEFOR0VfVVNFUl9FTkRQT0lOVCwge1xyXG4gICAgICBib2R5LFxyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGZpbGVVcGxvYWRUb1BhdGgoZmlsZTogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKCcvYXBpL2Nkbi9wdWJsaWMvdXBsb2FkRmlsZScsIHtcclxuICAgICAgbXVsdGlwYXJ0OiB0cnVlLFxyXG4gICAgICBwYXJhbXM6IHtcclxuICAgICAgICBmaWxlOiBmaWxlLFxyXG4gICAgICB9LFxyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0J1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBnZXRTZXJ2aWNlVXNlcigpIHtcclxuICAgIGNvbnN0IHNlcnZpY2VVc2VySWQgPSB0aGlzLnNpZ25lZEluLmFjdGl2ZVVzZXJJZDtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLkdFVChgJHtHRVRfU0VSVklDRV9VU0VSX0VORFBPSU5UfS8ke3NlcnZpY2VVc2VySWR9P2I9dHJ1ZWApO1xyXG4gIH1cclxuXHJcbiAgZW5jcnlwdCh0ZXh0OiBzdHJpbmcpIHtcclxuICAgIC8vIOydtOuvuCDslZTtmLjtmZQg7L2U65OcIOyDge2DnOydtOuptCDrsJjtmZhcclxuICAgIGlmIChOdW1iZXIuaXNOYU4oK3RleHQpKSB7XHJcbiAgICAgIHJldHVybiB0ZXh0O1xyXG4gICAgfVxyXG4gICAgY29uc3QgaXYgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZShjeXBoZXIuaW5pdFZlY3Rvcik7XHJcbiAgICBjb25zdCBrZXkgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZShjeXBoZXIuc2VjcmV0S2V5KTtcclxuICAgIGNvbnN0IGVuY3J5cHRlZCA9IENyeXB0b0pTLkFFUy5lbmNyeXB0KHRleHQsIGtleSwge2l2OiBpdiwgcGFkZGluZzogQ3J5cHRvSlMucGFkLlBrY3M3fSkudG9TdHJpbmcoKTtcclxuICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoZW5jcnlwdGVkKTtcclxuICB9XHJcblxyXG4gIGRlY3J5cHQodGV4dDogc3RyaW5nKSB7XHJcbiAgICBsZXQgZGVjb2RlVGV4dCA9IHRleHQ7XHJcbiAgICBsZXQgZGVjb2RlVVJJID0gZGVjb2RlVVJJQ29tcG9uZW50KGRlY29kZVRleHQpO1xyXG4gICAgd2hpbGUgKGRlY29kZVVSSSAhPSBkZWNvZGVUZXh0KSB7XHJcbiAgICAgIGRlY29kZVRleHQgPSBkZWNvZGVVUkk7XHJcbiAgICAgIGRlY29kZVVSSSA9IGRlY29kZVVSSUNvbXBvbmVudChkZWNvZGVUZXh0KTtcclxuICAgIH1cclxuICAgIGNvbnN0IGl2ID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoY3lwaGVyLmluaXRWZWN0b3IpO1xyXG4gICAgY29uc3Qga2V5ID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoY3lwaGVyLnNlY3JldEtleSk7XHJcbiAgICBjb25zdCBkZWNyeXB0ZWQgPSBDcnlwdG9KUy5BRVMuZGVjcnlwdChkZWNvZGVVUkksIGtleSwge2l2OiBpdiwgcGFkZGluZzogQ3J5cHRvSlMucGFkLlBrY3M3fSk7XHJcblxyXG4gICAgcmV0dXJuIGRlY3J5cHRlZC50b1N0cmluZyhDcnlwdG9KUy5lbmMuVXRmOCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==