import { Injectable } from '@angular/core';
import { BehaviorSubject, of, throwError } from 'rxjs';
import { catchError, map, mergeMap } from 'rxjs/operators';
import * as CryptoJS from 'crypto-js';
import * as i0 from "@angular/core";
import * as i1 from "@gollala/ng-common";
const SIGNIN_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/login';
const SIGNEDIN_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/info';
const SEND_EMAIL = 'https://gollala-email-zaj3pqrsqq-du.a.run.app/api/email/send/verification/';
const SIGNOUT_ENDPOINT = '/api/security/v3/signout';
const SIGNUP_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/register';
const CHANGE_USER_ENDPOINT = '/api/security/v3/changeUser';
const GET_SERVICE_USER_ENDPOINT = '/api/account/serviceUser/get/';
const cypher = {
    initVector: 'wiseSecretVector',
    secretKey: 'wise$billing$key'
};
export class SecurityService {
    constructor(restService) {
        this.restService = restService;
        this._signedIn = false;
        this.signedIn$ = new BehaviorSubject(this._signedIn);
    }
    get signedIn() {
        return this._signedIn;
    }
    signUpReqeust(body) {
        return this.restService.POST(SIGNUP_ENDPOINT, {
            body,
            handleError: true,
            responseType: 'text'
        });
    }
    sendEmail(body) {
        return this.restService.POST(SEND_EMAIL, {
            body,
            handleError: true
        });
    }
    getUserInfo() {
        return this.restService.GET(SIGNEDIN_ENDPOINT, {
            handleError: true
        });
    }
    isExpiredToken(token) {
        const { date } = JSON.parse(token);
        const current = +new Date();
        const diff = current - date;
        return diff > 604800000 ? true : false;
    }
    signInRequest(userId, password) {
        return this.restService.POST(SIGNIN_ENDPOINT, {
            body: {
                userId,
                password
            },
            handleError: true,
            responseType: 'text'
        }).pipe(catchError((e) => {
            console.log(e);
            return throwError(e);
        }), mergeMap(token => {
            const gollalaToken = {
                token,
                date: +new Date()
            };
            localStorage.setItem('gollala_token', JSON.stringify(gollalaToken));
            return this.signedInRequest();
        }));
    }
    signedInRequest() {
        return this.restService.GET(SIGNEDIN_ENDPOINT, {
            handleError: true
        }).pipe(catchError(e => {
            this._signedIn = false;
            this.signedIn$.next(false);
            return throwError(e);
        }), map((signedIn) => {
            const gollalaToken = localStorage.getItem('gollala_token');
            if (!gollalaToken || (gollalaToken && this.isExpiredToken(gollalaToken))) {
                this._signedIn = false;
                return false;
            }
            this._signedIn = signedIn;
            this.signedIn$.next({ ...signedIn });
            return true;
        }));
    }
    signInWithGoogleRequest(idToken, provider) {
        return this.restService.POST(`https://commerce-api.gollala.org/customer/auth/social`, {
            params: {
                idToken,
                provider,
            },
            handleError: true,
            responseType: 'text'
        }).pipe(catchError((e) => {
            console.log(e);
            return throwError(e);
        }), mergeMap(token => {
            const gollalaToken = {
                token,
                date: +new Date()
            };
            localStorage.setItem('gollala_token', JSON.stringify(gollalaToken));
            return this.signedInRequest();
        }));
    }
    signout() {
        localStorage.removeItem('gollala_token');
        this._signedIn = false;
        this.signedIn$.next(null);
    }
    /**
     * This method will be deprecated after menus and paths are properly set.
     */
    signOutRequest() {
        return this.restService.GET(SIGNOUT_ENDPOINT, {
            responseType: 'text',
            handleError: true,
        }).pipe(catchError(e => {
            return throwError(e);
        }), mergeMap(result => {
            this._signedIn = false;
            return of(true);
        }));
    }
    changeUser(body) {
        return this.restService.POST(CHANGE_USER_ENDPOINT, {
            body,
            handleError: true,
        });
    }
    fileUploadToPath(file) {
        return this.restService.POST('/api/cdn/public/uploadFile', {
            multipart: true,
            params: {
                file: file,
            },
            responseType: 'text'
        });
    }
    getServiceUser() {
        const serviceUserId = this.signedIn.activeUserId;
        return this.restService.GET(`${GET_SERVICE_USER_ENDPOINT}/${serviceUserId}?b=true`);
    }
    encrypt(text) {
        // 이미 암호화 코드 상태이면 반환
        if (Number.isNaN(+text)) {
            return text;
        }
        const iv = CryptoJS.enc.Utf8.parse(cypher.initVector);
        const key = CryptoJS.enc.Utf8.parse(cypher.secretKey);
        const encrypted = CryptoJS.AES.encrypt(text, key, { iv: iv, padding: CryptoJS.pad.Pkcs7 }).toString();
        return encodeURIComponent(encrypted);
    }
    decrypt(text) {
        let decodeText = text;
        let decodeURI = decodeURIComponent(decodeText);
        while (decodeURI != decodeText) {
            decodeText = decodeURI;
            decodeURI = decodeURIComponent(decodeText);
        }
        const iv = CryptoJS.enc.Utf8.parse(cypher.initVector);
        const key = CryptoJS.enc.Utf8.parse(cypher.secretKey);
        const decrypted = CryptoJS.AES.decrypt(decodeURI, key, { iv: iv, padding: CryptoJS.pad.Pkcs7 });
        return decrypted.toString(CryptoJS.enc.Utf8);
    }
}
SecurityService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, deps: [{ token: i1.RestService }], target: i0.ɵɵFactoryTarget.Injectable });
SecurityService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.RestService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHktc2VydmljZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctY29tbW9uL3NyYy9saWIvc2VydmljZS9zZWN1cml0eS1zZXJ2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsZUFBZSxFQUFtQixFQUFFLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBRXBFLE9BQU8sS0FBSyxRQUFRLE1BQU0sV0FBVyxDQUFDOzs7QUFFdEMsTUFBTSxlQUFlLEdBQUcsc0RBQXNELENBQUM7QUFDL0UsTUFBTSxpQkFBaUIsR0FBRyxxREFBcUQsQ0FBQztBQUNoRixNQUFNLFVBQVUsR0FBRyw0RUFBNEUsQ0FBQztBQUNoRyxNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBQ3BELE1BQU0sZUFBZSxHQUFHLHlEQUF5RCxDQUFDO0FBQ2xGLE1BQU0sb0JBQW9CLEdBQUcsNkJBQTZCLENBQUM7QUFDM0QsTUFBTSx5QkFBeUIsR0FBRywrQkFBK0IsQ0FBQztBQU9sRSxNQUFNLE1BQU0sR0FBVztJQUNyQixVQUFVLEVBQUUsa0JBQWtCO0lBQzlCLFNBQVMsRUFBRSxrQkFBa0I7Q0FDOUIsQ0FBQztBQUtGLE1BQU0sT0FBTyxlQUFlO0lBTTFCLFlBQ1UsV0FBd0I7UUFBeEIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFMM0IsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUV6QixjQUFTLEdBQUcsSUFBSSxlQUFlLENBQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBSWxELENBQUM7SUFFSixJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENB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QUFDLENBQUM7SUFDL0MsQ0FBQzs7NEdBM0xVLGVBQWU7Z0hBQWYsZUFBZSxjQUZkLE1BQU07MkZBRVAsZUFBZTtrQkFIM0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgaWlmLCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Y2F0Y2hFcnJvciwgbWFwLCBtZXJnZU1hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7UmVzdFNlcnZpY2V9IGZyb20gJ0Bnb2xsYWxhL25nLWNvbW1vbic7XHJcbmltcG9ydCAqIGFzIENyeXB0b0pTIGZyb20gJ2NyeXB0by1qcyc7XHJcblxyXG5jb25zdCBTSUdOSU5fRU5EUE9JTlQgPSAnaHR0cHM6Ly9jb21tZXJjZS1hcGkuZ29sbGFsYS5vcmcvY3VzdG9tZXIvYXV0aC9sb2dpbic7XHJcbmNvbnN0IFNJR05FRElOX0VORFBPSU5UID0gJ2h0dHBzOi8vY29tbWVyY2UtYXBpLmdvbGxhbGEub3JnL2N1c3RvbWVyL2F1dGgvaW5mbyc7XHJcbmNvbnN0IFNFTkRfRU1BSUwgPSAnaHR0cHM6Ly9nb2xsYWxhLWVtYWlsLXphajNwcXJzcXEtZHUuYS5ydW4uYXBwL2FwaS9lbWFpbC9zZW5kL3ZlcmlmaWNhdGlvbi8nO1xyXG5jb25zdCBTSUdOT1VUX0VORFBPSU5UID0gJy9hcGkvc2VjdXJpdHkvdjMvc2lnbm91dCc7XHJcbmNvbnN0IFNJR05VUF9FTkRQT0lOVCA9ICdodHRwczovL2NvbW1lcmNlLWFwaS5nb2xsYWxhLm9yZy9jdXN0b21lci9hdXRoL3JlZ2lzdGVyJztcclxuY29uc3QgQ0hBTkdFX1VTRVJfRU5EUE9JTlQgPSAnL2FwaS9zZWN1cml0eS92My9jaGFuZ2VVc2VyJztcclxuY29uc3QgR0VUX1NFUlZJQ0VfVVNFUl9FTkRQT0lOVCA9ICcvYXBpL2FjY291bnQvc2VydmljZVVzZXIvZ2V0Lyc7XHJcblxyXG5pbnRlcmZhY2UgQ3lwaGVyIHtcclxuICAgIGluaXRWZWN0b3I6IHN0cmluZztcclxuICAgIHNlY3JldEtleTogc3RyaW5nO1xyXG59XHJcblxyXG5jb25zdCBjeXBoZXI6IEN5cGhlciA9IHtcclxuICBpbml0VmVjdG9yOiAnd2lzZVNlY3JldFZlY3RvcicsXHJcbiAgc2VjcmV0S2V5OiAnd2lzZSRiaWxsaW5nJGtleSdcclxufTtcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFNlY3VyaXR5U2VydmljZSB7XHJcblxyXG4gIHB1YmxpYyBfc2lnbmVkSW4gPSBmYWxzZTtcclxuXHJcbiAgc2lnbmVkSW4kID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnk+KHRoaXMuX3NpZ25lZEluKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlc3RTZXJ2aWNlOiBSZXN0U2VydmljZSxcclxuICApIHt9XHJcblxyXG4gIGdldCBzaWduZWRJbigpOiBhbnkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3NpZ25lZEluO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNpZ25VcFJlcWV1c3QoYm9keTogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKFNJR05VUF9FTkRQT0lOVCwge1xyXG4gICAgICBib2R5LFxyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZSxcclxuICAgICAgcmVzcG9uc2VUeXBlOiAndGV4dCdcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNlbmRFbWFpbChib2R5OiBhbnkpIHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLlBPU1QoU0VORF9FTUFJTCwge1xyXG4gICAgICBib2R5LFxyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgcHVibGljIGdldFVzZXJJbmZvKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuR0VUKFNJR05FRElOX0VORFBPSU5ULCB7XHJcbiAgICAgIGhhbmRsZUVycm9yOiB0cnVlXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBpc0V4cGlyZWRUb2tlbih0b2tlbjogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB7ZGF0ZX0gPSBKU09OLnBhcnNlKHRva2VuKVxyXG4gICAgY29uc3QgY3VycmVudCA9ICtuZXcgRGF0ZSgpO1xyXG4gICAgY29uc3QgZGlmZiA9IGN1cnJlbnQgLSBkYXRlO1xyXG5cclxuICAgIHJldHVybiBkaWZmID4gNjA0ODAwMDAwID8gdHJ1ZSA6IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNpZ25JblJlcXVlc3QodXNlcklkOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLlBPU1QoU0lHTklOX0VORFBPSU5ULCB7XHJcbiAgICAgIGJvZHk6IHtcclxuICAgICAgICB1c2VySWQsXHJcbiAgICAgICAgcGFzc3dvcmRcclxuICAgICAgfSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWUsXHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9KS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKChlKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZSk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBtZXJnZU1hcCh0b2tlbiA9PiB7XHJcbiAgICAgICAgY29uc3QgZ29sbGFsYVRva2VuID0ge1xyXG4gICAgICAgICAgdG9rZW4sXHJcbiAgICAgICAgICBkYXRlOiArbmV3IERhdGUoKVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdnb2xsYWxhX3Rva2VuJywgSlNPTi5zdHJpbmdpZnkoZ29sbGFsYVRva2VuKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2lnbmVkSW5SZXF1ZXN0KCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNpZ25lZEluUmVxdWVzdCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLkdFVChTSUdORURJTl9FTkRQT0lOVCwge1xyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZVxyXG4gICAgfSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcihlID0+IHtcclxuICAgICAgICB0aGlzLl9zaWduZWRJbiA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMuc2lnbmVkSW4kLm5leHQoZmFsc2UpO1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGUpO1xyXG4gICAgICB9KSxcclxuICAgICAgbWFwKChzaWduZWRJbik6IGFueSA9PiB7XHJcbiAgICAgICAgY29uc3QgZ29sbGFsYVRva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2dvbGxhbGFfdG9rZW4nKTtcclxuICAgICAgICBpZiAoIWdvbGxhbGFUb2tlbiB8fCAoZ29sbGFsYVRva2VuICYmIHRoaXMuaXNFeHBpcmVkVG9rZW4oZ29sbGFsYVRva2VuKSkpIHtcclxuICAgICAgICAgIHRoaXMuX3NpZ25lZEluID0gZmFsc2U7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX3NpZ25lZEluID0gc2lnbmVkSW47XHJcbiAgICAgICAgdGhpcy5zaWduZWRJbiQubmV4dCh7Li4uc2lnbmVkSW59KTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2lnbkluV2l0aEdvb2dsZVJlcXVlc3QoaWRUb2tlbjogc3RyaW5nLCBwcm92aWRlcjogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKGBodHRwczovL2NvbW1lcmNlLWFwaS5nb2xsYWxhLm9yZy9jdXN0b21lci9hdXRoL3NvY2lhbGAsIHtcclxuICAgICAgcGFyYW1zOiB7XHJcbiAgICAgICAgaWRUb2tlbixcclxuICAgICAgICBwcm92aWRlcixcclxuICAgICAgfSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWUsXHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9KS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKChlKSA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZSk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBtZXJnZU1hcCh0b2tlbiA9PiB7XHJcbiAgICAgICAgY29uc3QgZ29sbGFsYVRva2VuID0ge1xyXG4gICAgICAgICAgdG9rZW4sXHJcbiAgICAgICAgICBkYXRlOiArbmV3IERhdGUoKVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdnb2xsYWxhX3Rva2VuJywgSlNPTi5zdHJpbmdpZnkoZ29sbGFsYVRva2VuKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc2lnbmVkSW5SZXF1ZXN0KCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNpZ25vdXQoKSB7XHJcbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnZ29sbGFsYV90b2tlbicpO1xyXG4gICAgdGhpcy5fc2lnbmVkSW4gPSBmYWxzZTtcclxuICAgIHRoaXMuc2lnbmVkSW4kLm5leHQobnVsbCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogVGhpcyBtZXRob2Qgd2lsbCBiZSBkZXByZWNhdGVkIGFmdGVyIG1lbnVzIGFuZCBwYXRocyBhcmUgcHJvcGVybHkgc2V0LlxyXG4gICAqL1xyXG5cclxuICBwdWJsaWMgc2lnbk91dFJlcXVlc3QoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5HRVQoU0lHTk9VVF9FTkRQT0lOVCwge1xyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0JyxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWUsXHJcbiAgICB9KS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKGUgPT4ge1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGUpO1xyXG4gICAgICB9KSxcclxuICAgICAgbWVyZ2VNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICB0aGlzLl9zaWduZWRJbiA9IGZhbHNlO1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgY2hhbmdlVXNlcihib2R5OiBhbnkpIHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLlBPU1QoQ0hBTkdFX1VTRVJfRU5EUE9JTlQsIHtcclxuICAgICAgYm9keSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWUsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBmaWxlVXBsb2FkVG9QYXRoKGZpbGU6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuUE9TVCgnL2FwaS9jZG4vcHVibGljL3VwbG9hZEZpbGUnLCB7XHJcbiAgICAgIG11bHRpcGFydDogdHJ1ZSxcclxuICAgICAgcGFyYW1zOiB7XHJcbiAgICAgICAgZmlsZTogZmlsZSxcclxuICAgICAgfSxcclxuICAgICAgcmVzcG9uc2VUeXBlOiAndGV4dCdcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0U2VydmljZVVzZXIoKSB7XHJcbiAgICBjb25zdCBzZXJ2aWNlVXNlcklkID0gdGhpcy5zaWduZWRJbi5hY3RpdmVVc2VySWQ7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5HRVQoYCR7R0VUX1NFUlZJQ0VfVVNFUl9FTkRQT0lOVH0vJHtzZXJ2aWNlVXNlcklkfT9iPXRydWVgKTtcclxuICB9XHJcblxyXG4gIGVuY3J5cHQodGV4dDogc3RyaW5nKSB7XHJcbiAgICAvLyDsnbTrr7gg7JWU7Zi47ZmUIOy9lOuTnCDsg4Htg5zsnbTrqbQg67CY7ZmYXHJcbiAgICBpZiAoTnVtYmVyLmlzTmFOKCt0ZXh0KSkge1xyXG4gICAgICByZXR1cm4gdGV4dDtcclxuICAgIH1cclxuICAgIGNvbnN0IGl2ID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoY3lwaGVyLmluaXRWZWN0b3IpO1xyXG4gICAgY29uc3Qga2V5ID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoY3lwaGVyLnNlY3JldEtleSk7XHJcbiAgICBjb25zdCBlbmNyeXB0ZWQgPSBDcnlwdG9KUy5BRVMuZW5jcnlwdCh0ZXh0LCBrZXksIHtpdjogaXYsIHBhZGRpbmc6IENyeXB0b0pTLnBhZC5Qa2NzN30pLnRvU3RyaW5nKCk7XHJcbiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KGVuY3J5cHRlZCk7XHJcbiAgfVxyXG5cclxuICBkZWNyeXB0KHRleHQ6IHN0cmluZykge1xyXG4gICAgbGV0IGRlY29kZVRleHQgPSB0ZXh0O1xyXG4gICAgbGV0IGRlY29kZVVSSSA9IGRlY29kZVVSSUNvbXBvbmVudChkZWNvZGVUZXh0KTtcclxuICAgIHdoaWxlIChkZWNvZGVVUkkgIT0gZGVjb2RlVGV4dCkge1xyXG4gICAgICBkZWNvZGVUZXh0ID0gZGVjb2RlVVJJO1xyXG4gICAgICBkZWNvZGVVUkkgPSBkZWNvZGVVUklDb21wb25lbnQoZGVjb2RlVGV4dCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBpdiA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKGN5cGhlci5pbml0VmVjdG9yKTtcclxuICAgIGNvbnN0IGtleSA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKGN5cGhlci5zZWNyZXRLZXkpO1xyXG4gICAgY29uc3QgZGVjcnlwdGVkID0gQ3J5cHRvSlMuQUVTLmRlY3J5cHQoZGVjb2RlVVJJLCBrZXksIHtpdjogaXYsIHBhZGRpbmc6IENyeXB0b0pTLnBhZC5Qa2NzN30pO1xyXG5cclxuICAgIHJldHVybiBkZWNyeXB0ZWQudG9TdHJpbmcoQ3J5cHRvSlMuZW5jLlV0ZjgpO1xyXG4gIH1cclxufVxyXG4iXX0=