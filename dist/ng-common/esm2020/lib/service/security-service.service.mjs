import { Injectable } from '@angular/core';
import { BehaviorSubject, of, throwError } from 'rxjs';
import { catchError, map, mergeMap } from 'rxjs/operators';
import * as CryptoJS from 'crypto-js';
import * as i0 from "@angular/core";
import * as i1 from "@gollala/ng-common";
const SIGNIN_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/login';
const SIGNEDIN_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/info';
const SEND_EMAIL = 'https://gollala-email-zaj3pqrsqq-du.a.run.app/api/email/send/verification/';
const SIGNOUT_ENDPOINT = '/api/security/v3/signout';
const SIGNUP_ENDPOINT = 'https://commerce-api.gollala.org/customer/auth/register';
const CHANGE_USER_ENDPOINT = '/api/security/v3/changeUser';
const GET_SERVICE_USER_ENDPOINT = '/api/account/serviceUser/get/';
const cypher = {
    initVector: 'wiseSecretVector',
    secretKey: 'wise$billing$key'
};
export class SecurityService {
    constructor(restService) {
        this.restService = restService;
        this._signedIn = false;
        this.signedIn$ = new BehaviorSubject(this._signedIn);
    }
    get signedIn() {
        return this._signedIn;
    }
    signUpReqeust(body) {
        return this.restService.POST(SIGNUP_ENDPOINT, {
            body,
            handleError: true,
            responseType: 'text'
        });
    }
    sendEmail(body) {
        return this.restService.POST(SEND_EMAIL, {
            body,
            handleError: true
        });
    }
    getUserInfo() {
        return this.restService.GET(SIGNEDIN_ENDPOINT, {
            handleError: true
        });
    }
    isExpiredToken(token) {
        const { date } = JSON.parse(token);
        const current = +new Date();
        const diff = current - date;
        return diff > 604800000 ? true : false;
    }
    signInRequest(userId, password) {
        return this.restService.POST(SIGNIN_ENDPOINT, {
            body: {
                userId,
                password
            },
            handleError: true,
            responseType: 'text'
        }).pipe(catchError((e) => {
            console.log(e);
            return throwError(e);
        }), mergeMap(token => {
            const gollalaToken = {
                token,
                date: +new Date()
            };
            localStorage.setItem('gollala_token', JSON.stringify(gollalaToken));
            return this.signedInRequest();
        }));
    }
    signedInRequest() {
        return this.restService.GET(SIGNEDIN_ENDPOINT, {
            handleError: true
        }).pipe(catchError(e => {
            this._signedIn = false;
            this.signedIn$.next(false);
            return throwError(e);
        }), map((signedIn) => {
            const gollalaToken = localStorage.getItem('gollala_token');
            if (!gollalaToken || (gollalaToken && this.isExpiredToken(gollalaToken))) {
                this._signedIn = false;
                return false;
            }
            this._signedIn = signedIn;
            this.signedIn$.next({ ...signedIn });
            return true;
        }));
    }
    signInWithGoogleRequest(idToken, provider) {
        return this.restService.POST(`https://commerce-api.gollala.org/customer/auth/social`, {
            params: {
                idToken,
                provider,
            },
            handleError: true,
            responseType: 'text'
        }).pipe(catchError((e) => {
            console.log(e);
            return throwError(e);
        }), mergeMap(token => {
            const gollalaToken = {
                token,
                date: +new Date()
            };
            localStorage.setItem('gollala_token', JSON.stringify(gollalaToken));
            return this.signedInRequest();
        }));
    }
    signout() {
        localStorage.removeItem('gollala_token');
        this._signedIn = false;
        this.signedIn$.next(null);
    }
    /**
     * This method will be deprecated after menus and paths are properly set.
     */
    signOutRequest() {
        return this.restService.GET(SIGNOUT_ENDPOINT, {
            responseType: 'text',
            handleError: true,
        }).pipe(catchError(e => {
            return throwError(e);
        }), mergeMap(result => {
            this._signedIn = false;
            return of(true);
        }));
    }
    changeUser(body) {
        return this.restService.POST(CHANGE_USER_ENDPOINT, {
            body,
            handleError: true,
        });
    }
    fileUploadToPath(file) {
        return this.restService.POST('/api/cdn/public/uploadFile', {
            multipart: true,
            params: {
                file: file,
            },
            responseType: 'text'
        });
    }
    getServiceUser() {
        const serviceUserId = this.signedIn.activeUserId;
        return this.restService.GET(`${GET_SERVICE_USER_ENDPOINT}/${serviceUserId}?b=true`);
    }
    encrypt(text) {
        // 이미 암호화 코드 상태이면 반환
        if (Number.isNaN(+text)) {
            return text;
        }
        const iv = CryptoJS.enc.Utf8.parse(cypher.initVector);
        const key = CryptoJS.enc.Utf8.parse(cypher.secretKey);
        const encrypted = CryptoJS.AES.encrypt(text, key, { iv: iv, padding: CryptoJS.pad.Pkcs7 }).toString();
        return encodeURIComponent(encrypted);
    }
    decrypt(text) {
        let decodeText = text;
        let decodeURI = decodeURIComponent(decodeText);
        while (decodeURI != decodeText) {
            decodeText = decodeURI;
            decodeURI = decodeURIComponent(decodeText);
        }
        const iv = CryptoJS.enc.Utf8.parse(cypher.initVector);
        const key = CryptoJS.enc.Utf8.parse(cypher.secretKey);
        const decrypted = CryptoJS.AES.decrypt(decodeURI, key, { iv: iv, padding: CryptoJS.pad.Pkcs7 });
        return decrypted.toString(CryptoJS.enc.Utf8);
    }
}
SecurityService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, deps: [{ token: i1.RestService }], target: i0.ɵɵFactoryTarget.Injectable });
SecurityService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: SecurityService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.RestService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHktc2VydmljZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctY29tbW9uL3NyYy9saWIvc2VydmljZS9zZWN1cml0eS1zZXJ2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsZUFBZSxFQUFtQixFQUFFLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBWSxNQUFNLGdCQUFnQixDQUFDO0FBRXBFLE9BQU8sS0FBSyxRQUFRLE1BQU0sV0FBVyxDQUFDOzs7QUFHdEMsTUFBTSxlQUFlLEdBQUcsc0RBQXNELENBQUM7QUFDL0UsTUFBTSxpQkFBaUIsR0FBRyxxREFBcUQsQ0FBQztBQUNoRixNQUFNLFVBQVUsR0FBRyw0RUFBNEUsQ0FBQztBQUNoRyxNQUFNLGdCQUFnQixHQUFHLDBCQUEwQixDQUFDO0FBQ3BELE1BQU0sZUFBZSxHQUFHLHlEQUF5RCxDQUFDO0FBQ2xGLE1BQU0sb0JBQW9CLEdBQUcsNkJBQTZCLENBQUM7QUFDM0QsTUFBTSx5QkFBeUIsR0FBRywrQkFBK0IsQ0FBQztBQU9sRSxNQUFNLE1BQU0sR0FBVztJQUNyQixVQUFVLEVBQUUsa0JBQWtCO0lBQzlCLFNBQVMsRUFBRSxrQkFBa0I7Q0FDOUIsQ0FBQztBQUtGLE1BQU0sT0FBTyxlQUFlO0lBTTFCLFlBQ1UsV0FBd0I7UUFBeEIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFMM0IsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUV6QixjQUFTLEdBQUcsSUFBSSxlQUFlLENBQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBSWxELENBQUM7SUFFSixJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENB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QUFDLENBQUM7SUFDL0MsQ0FBQzs7NEdBM0xVLGVBQWU7Z0hBQWYsZUFBZSxjQUZkLE1BQU07MkZBRVAsZUFBZTtrQkFIM0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge0JlaGF2aW9yU3ViamVjdCwgaWlmLCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7Y2F0Y2hFcnJvciwgbWFwLCBtZXJnZU1hcCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7UmVzdFNlcnZpY2V9IGZyb20gJ0Bnb2xsYWxhL25nLWNvbW1vbic7XHJcbmltcG9ydCAqIGFzIENyeXB0b0pTIGZyb20gJ2NyeXB0by1qcyc7XHJcbmltcG9ydCB7SHR0cEhlYWRlcnN9IGZyb20gXCJAYW5ndWxhci9jb21tb24vaHR0cFwiO1xyXG5cclxuY29uc3QgU0lHTklOX0VORFBPSU5UID0gJ2h0dHBzOi8vY29tbWVyY2UtYXBpLmdvbGxhbGEub3JnL2N1c3RvbWVyL2F1dGgvbG9naW4nO1xyXG5jb25zdCBTSUdORURJTl9FTkRQT0lOVCA9ICdodHRwczovL2NvbW1lcmNlLWFwaS5nb2xsYWxhLm9yZy9jdXN0b21lci9hdXRoL2luZm8nO1xyXG5jb25zdCBTRU5EX0VNQUlMID0gJ2h0dHBzOi8vZ29sbGFsYS1lbWFpbC16YWozcHFyc3FxLWR1LmEucnVuLmFwcC9hcGkvZW1haWwvc2VuZC92ZXJpZmljYXRpb24vJztcclxuY29uc3QgU0lHTk9VVF9FTkRQT0lOVCA9ICcvYXBpL3NlY3VyaXR5L3YzL3NpZ25vdXQnO1xyXG5jb25zdCBTSUdOVVBfRU5EUE9JTlQgPSAnaHR0cHM6Ly9jb21tZXJjZS1hcGkuZ29sbGFsYS5vcmcvY3VzdG9tZXIvYXV0aC9yZWdpc3Rlcic7XHJcbmNvbnN0IENIQU5HRV9VU0VSX0VORFBPSU5UID0gJy9hcGkvc2VjdXJpdHkvdjMvY2hhbmdlVXNlcic7XHJcbmNvbnN0IEdFVF9TRVJWSUNFX1VTRVJfRU5EUE9JTlQgPSAnL2FwaS9hY2NvdW50L3NlcnZpY2VVc2VyL2dldC8nO1xyXG5cclxuaW50ZXJmYWNlIEN5cGhlciB7XHJcbiAgICBpbml0VmVjdG9yOiBzdHJpbmc7XHJcbiAgICBzZWNyZXRLZXk6IHN0cmluZztcclxufVxyXG5cclxuY29uc3QgY3lwaGVyOiBDeXBoZXIgPSB7XHJcbiAgaW5pdFZlY3RvcjogJ3dpc2VTZWNyZXRWZWN0b3InLFxyXG4gIHNlY3JldEtleTogJ3dpc2UkYmlsbGluZyRrZXknXHJcbn07XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTZWN1cml0eVNlcnZpY2Uge1xyXG5cclxuICBwdWJsaWMgX3NpZ25lZEluID0gZmFsc2U7XHJcblxyXG4gIHNpZ25lZEluJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55Pih0aGlzLl9zaWduZWRJbik7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSByZXN0U2VydmljZTogUmVzdFNlcnZpY2UsXHJcbiAgKSB7fVxyXG5cclxuICBnZXQgc2lnbmVkSW4oKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl9zaWduZWRJbjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduVXBSZXFldXN0KGJvZHk6IGFueSkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuUE9TVChTSUdOVVBfRU5EUE9JTlQsIHtcclxuICAgICAgYm9keSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWUsXHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzZW5kRW1haWwoYm9keTogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKFNFTkRfRU1BSUwsIHtcclxuICAgICAgYm9keSxcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWVcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcblxyXG4gIHB1YmxpYyBnZXRVc2VySW5mbygpIHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLkdFVChTSUdORURJTl9FTkRQT0lOVCwge1xyXG4gICAgICBoYW5kbGVFcnJvcjogdHJ1ZVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaXNFeHBpcmVkVG9rZW4odG9rZW46IHN0cmluZykge1xyXG4gICAgY29uc3Qge2RhdGV9ID0gSlNPTi5wYXJzZSh0b2tlbilcclxuICAgIGNvbnN0IGN1cnJlbnQgPSArbmV3IERhdGUoKTtcclxuICAgIGNvbnN0IGRpZmYgPSBjdXJyZW50IC0gZGF0ZTtcclxuXHJcbiAgICByZXR1cm4gZGlmZiA+IDYwNDgwMDAwMCA/IHRydWUgOiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduSW5SZXF1ZXN0KHVzZXJJZDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKFNJR05JTl9FTkRQT0lOVCwge1xyXG4gICAgICBib2R5OiB7XHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIHBhc3N3b3JkXHJcbiAgICAgIH0sXHJcbiAgICAgIGhhbmRsZUVycm9yOiB0cnVlLFxyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0J1xyXG4gICAgfSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcigoZSkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGUpO1xyXG4gICAgICB9KSxcclxuICAgICAgbWVyZ2VNYXAodG9rZW4gPT4ge1xyXG4gICAgICAgIGNvbnN0IGdvbGxhbGFUb2tlbiA9IHtcclxuICAgICAgICAgIHRva2VuLFxyXG4gICAgICAgICAgZGF0ZTogK25ldyBEYXRlKClcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ29sbGFsYV90b2tlbicsIEpTT04uc3RyaW5naWZ5KGdvbGxhbGFUb2tlbikpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNpZ25lZEluUmVxdWVzdCgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWduZWRJblJlcXVlc3QoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5HRVQoU0lHTkVESU5fRU5EUE9JTlQsIHtcclxuICAgICAgaGFuZGxlRXJyb3I6IHRydWVcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZSA9PiB7XHJcbiAgICAgICAgdGhpcy5fc2lnbmVkSW4gPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnNpZ25lZEluJC5uZXh0KGZhbHNlKTtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlKTtcclxuICAgICAgfSksXHJcbiAgICAgIG1hcCgoc2lnbmVkSW4pOiBhbnkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGdvbGxhbGFUb2tlbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdnb2xsYWxhX3Rva2VuJyk7XHJcbiAgICAgICAgaWYgKCFnb2xsYWxhVG9rZW4gfHwgKGdvbGxhbGFUb2tlbiAmJiB0aGlzLmlzRXhwaXJlZFRva2VuKGdvbGxhbGFUb2tlbikpKSB7XHJcbiAgICAgICAgICB0aGlzLl9zaWduZWRJbiA9IGZhbHNlO1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9zaWduZWRJbiA9IHNpZ25lZEluO1xyXG4gICAgICAgIHRoaXMuc2lnbmVkSW4kLm5leHQoey4uLnNpZ25lZElufSk7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHNpZ25JbldpdGhHb29nbGVSZXF1ZXN0KGlkVG9rZW46IHN0cmluZywgcHJvdmlkZXI6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuUE9TVChgaHR0cHM6Ly9jb21tZXJjZS1hcGkuZ29sbGFsYS5vcmcvY3VzdG9tZXIvYXV0aC9zb2NpYWxgLCB7XHJcbiAgICAgIHBhcmFtczoge1xyXG4gICAgICAgIGlkVG9rZW4sXHJcbiAgICAgICAgcHJvdmlkZXIsXHJcbiAgICAgIH0sXHJcbiAgICAgIGhhbmRsZUVycm9yOiB0cnVlLFxyXG4gICAgICByZXNwb25zZVR5cGU6ICd0ZXh0J1xyXG4gICAgfSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcigoZSkgPT4ge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGUpO1xyXG4gICAgICB9KSxcclxuICAgICAgbWVyZ2VNYXAodG9rZW4gPT4ge1xyXG4gICAgICAgIGNvbnN0IGdvbGxhbGFUb2tlbiA9IHtcclxuICAgICAgICAgIHRva2VuLFxyXG4gICAgICAgICAgZGF0ZTogK25ldyBEYXRlKClcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZ29sbGFsYV90b2tlbicsIEpTT04uc3RyaW5naWZ5KGdvbGxhbGFUb2tlbikpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNpZ25lZEluUmVxdWVzdCgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzaWdub3V0KCkge1xyXG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oJ2dvbGxhbGFfdG9rZW4nKTtcclxuICAgIHRoaXMuX3NpZ25lZEluID0gZmFsc2U7XHJcbiAgICB0aGlzLnNpZ25lZEluJC5uZXh0KG51bGwpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgZGVwcmVjYXRlZCBhZnRlciBtZW51cyBhbmQgcGF0aHMgYXJlIHByb3Blcmx5IHNldC5cclxuICAgKi9cclxuXHJcbiAgcHVibGljIHNpZ25PdXRSZXF1ZXN0KCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuR0VUKFNJR05PVVRfRU5EUE9JTlQsIHtcclxuICAgICAgcmVzcG9uc2VUeXBlOiAndGV4dCcsXHJcbiAgICAgIGhhbmRsZUVycm9yOiB0cnVlLFxyXG4gICAgfSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcihlID0+IHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlKTtcclxuICAgICAgfSksXHJcbiAgICAgIG1lcmdlTWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgdGhpcy5fc2lnbmVkSW4gPSBmYWxzZTtcclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNoYW5nZVVzZXIoYm9keTogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5QT1NUKENIQU5HRV9VU0VSX0VORFBPSU5ULCB7XHJcbiAgICAgIGJvZHksXHJcbiAgICAgIGhhbmRsZUVycm9yOiB0cnVlLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZmlsZVVwbG9hZFRvUGF0aChmaWxlOiBhbnkpIHtcclxuICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLlBPU1QoJy9hcGkvY2RuL3B1YmxpYy91cGxvYWRGaWxlJywge1xyXG4gICAgICBtdWx0aXBhcnQ6IHRydWUsXHJcbiAgICAgIHBhcmFtczoge1xyXG4gICAgICAgIGZpbGU6IGZpbGUsXHJcbiAgICAgIH0sXHJcbiAgICAgIHJlc3BvbnNlVHlwZTogJ3RleHQnXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldFNlcnZpY2VVc2VyKCkge1xyXG4gICAgY29uc3Qgc2VydmljZVVzZXJJZCA9IHRoaXMuc2lnbmVkSW4uYWN0aXZlVXNlcklkO1xyXG4gICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuR0VUKGAke0dFVF9TRVJWSUNFX1VTRVJfRU5EUE9JTlR9LyR7c2VydmljZVVzZXJJZH0/Yj10cnVlYCk7XHJcbiAgfVxyXG5cclxuICBlbmNyeXB0KHRleHQ6IHN0cmluZykge1xyXG4gICAgLy8g7J2066+4IOyVlO2YuO2ZlCDsvZTrk5wg7IOB7YOc7J2066m0IOuwmO2ZmFxyXG4gICAgaWYgKE51bWJlci5pc05hTigrdGV4dCkpIHtcclxuICAgICAgcmV0dXJuIHRleHQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCBpdiA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKGN5cGhlci5pbml0VmVjdG9yKTtcclxuICAgIGNvbnN0IGtleSA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKGN5cGhlci5zZWNyZXRLZXkpO1xyXG4gICAgY29uc3QgZW5jcnlwdGVkID0gQ3J5cHRvSlMuQUVTLmVuY3J5cHQodGV4dCwga2V5LCB7aXY6IGl2LCBwYWRkaW5nOiBDcnlwdG9KUy5wYWQuUGtjczd9KS50b1N0cmluZygpO1xyXG4gICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChlbmNyeXB0ZWQpO1xyXG4gIH1cclxuXHJcbiAgZGVjcnlwdCh0ZXh0OiBzdHJpbmcpIHtcclxuICAgIGxldCBkZWNvZGVUZXh0ID0gdGV4dDtcclxuICAgIGxldCBkZWNvZGVVUkkgPSBkZWNvZGVVUklDb21wb25lbnQoZGVjb2RlVGV4dCk7XHJcbiAgICB3aGlsZSAoZGVjb2RlVVJJICE9IGRlY29kZVRleHQpIHtcclxuICAgICAgZGVjb2RlVGV4dCA9IGRlY29kZVVSSTtcclxuICAgICAgZGVjb2RlVVJJID0gZGVjb2RlVVJJQ29tcG9uZW50KGRlY29kZVRleHQpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaXYgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZShjeXBoZXIuaW5pdFZlY3Rvcik7XHJcbiAgICBjb25zdCBrZXkgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZShjeXBoZXIuc2VjcmV0S2V5KTtcclxuICAgIGNvbnN0IGRlY3J5cHRlZCA9IENyeXB0b0pTLkFFUy5kZWNyeXB0KGRlY29kZVVSSSwga2V5LCB7aXY6IGl2LCBwYWRkaW5nOiBDcnlwdG9KUy5wYWQuUGtjczd9KTtcclxuXHJcbiAgICByZXR1cm4gZGVjcnlwdGVkLnRvU3RyaW5nKENyeXB0b0pTLmVuYy5VdGY4KTtcclxuICB9XHJcbn1cclxuIl19